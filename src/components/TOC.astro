---
import type { MarkdownHeading } from "astro";
import { SUPPORTED_LOCALES, type Locale } from "../i18n/strings";

type Props = { heading: MarkdownHeading[] };
const { heading } = Astro.props;

const buildHref = (target: Locale) => {
  const segments = Astro.url.pathname.split("/").filter(Boolean);
  // ensure locale is always at index 0 when prefixDefaultLocale is on
  if (!segments.length) return `/${target}`;
  segments[0] = target;
  return `/${segments.join("/")}`;
};

function stripLeadingNumbering(input: string) {
  // ^\s*          : 开头空格
  // (\d+(?:\.\d+)*) : 1 / 1.2 / 1.2.3
  // \.?           : 可选的结尾点（兼容 "1."）
  // \s+           : 至少一个空白（确保不是在处理 "1.2.3abc" 这种）
  const re = /^\s*(\d+(?:\.\d+)*)\.?\s+/u;
  return input.replace(re, "");
}
---

<div class="toc" data-alignment="center">
  <button class="trigger" popovertarget="index" popovertargetaction="toggle">
    <div class="trigger__details">
      <svg
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <mask
          id="mask0_3000_5"
          maskUnits="userSpaceOnUse"
          x="0"
          y="2"
          width="24"
          height="20"
        >
          <path
            d="M3 6.75L19.0541 6.75L21.027 6.75H23.0135L23 3.5L1 3.5L1 12L23 12L23.0135 21L1 21L1 17.25L13 17.25"
            stroke-width="2.5"
            stroke="gray"></path>
        </mask>
        <g mask="url(#mask0_3000_5)">
          <rect x="3" y="6" width="18" height="12" fill="gray"></rect>
        </g>
        <mask
          id="mask1_3000_5"
          maskUnits="userSpaceOnUse"
          x="0"
          y="2"
          width="24"
          height="20"
        >
          <path
            class="lines"
            d="M3 6.75L19.0541 6.75L21.027 6.75H23.0135L23 3.5L1 3.5L1 12L23 12L23.0135 21L1 21L1 17.25L13 17.25"
            stroke="white"
            stroke-width="2.5"
            pathLength="1.025"
            stroke-dasharray="1.025"
            stroke-dashoffset="1.025"></path>
        </mask>
        <g mask="url(#mask1_3000_5)">
          <rect x="3" y="6" width="18" height="12" fill="white"></rect>
        </g>
      </svg>

      <span>
        <span>Index</span><svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="size-6"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M8.25 15 12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9"></path>
        </svg>
      </span>
      <span class="progress"></span>
    </div>
  </button>
  <div popover="auto" id="index">
    <div class="contents">
      <button popovertarget="index" popovertargetaction="hide">
        <div class="trigger__details">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <mask
              id="mask0_3000_5"
              maskUnits="userSpaceOnUse"
              x="0"
              y="2"
              width="24"
              height="20"
            >
              <path
                d="M3 6.75L19.0541 6.75L21.027 6.75H23.0135L23 3.5L1 3.5L1 12L23 12L23.0135 21L1 21L1 17.25L13 17.25"
                stroke-width="2.5"
                stroke="gray"></path>
            </mask>
            <g mask="url(#mask0_3000_5)">
              <rect x="3" y="6" width="18" height="12" fill="gray"></rect>
            </g>
            <mask
              id="mask1_3000_5"
              maskUnits="userSpaceOnUse"
              x="0"
              y="2"
              width="24"
              height="20"
            >
              <path
                class="lines"
                d="M3 6.75L19.0541 6.75L21.027 6.75H23.0135L23 3.5L1 3.5L1 12L23 12L23.0135 21L1 21L1 17.25L13 17.25"
                stroke="white"
                stroke-width="2.5"
                pathLength="1.025"
                stroke-dasharray="1.025"
                stroke-dashoffset="1.025"></path>
            </mask>
            <g mask="url(#mask1_3000_5)">
              <rect x="3" y="6" width="18" height="12" fill="white"></rect>
            </g>
          </svg>

          <span>
            <span>Index</span><svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="size-6"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M8.25 15 12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9"></path>
            </svg>
          </span>
          <span class="progress"></span>
        </div>
      </button>
      <ol id="h-ol">
        {
          heading
            .filter((item) => item.depth == 2)
            .map((item) => (
              <li>
                <button
                  popovertarget="index"
                  popovertargetaction="hide"
                  data-href={"#" + item.slug}
                >
                  {stripLeadingNumbering(item.text)}
                </button>
              </li>
            ))
        }
      </ol>
    </div>
  </div>
</div>

<script>
  const headingLists = document.getElementById("h-ol")! as HTMLOListElement;
  headingLists.addEventListener("click", function (e) {
    if (e.target instanceof HTMLButtonElement) {
      location.hash = e.target.dataset.href!;
    }
  });
</script>

<style is:global>
  @layer base, demo, scroll;

  @layer popover {
    :root {
      --bottom: 2rem;
      --speed: 0.3s;
      --power-in: linear(
        0 0%,
        0.0039 6.25%,
        0.0156 12.5%,
        0.0352 18.75%,
        0.0625 25%,
        0.0977 31.25%,
        0.1407 37.5%,
        0.1914 43.74%,
        0.2499 49.99%,
        0.3164 56.25%,
        0.3906 62.5%,
        0.5625 75%,
        0.7656 87.5%,
        1 100%
      );
      --power-in-out: linear(
        0 0%,
        0.0012 14.95%,
        0.0089 22.36%,
        0.0297 28.43%,
        0.0668 33.43%,
        0.0979 36.08%,
        0.1363 38.55%,
        0.2373 43.07%,
        0.3675 47.01%,
        0.5984 52.15%,
        0.7121 55.23%,
        0.8192 59.21%,
        0.898 63.62%,
        0.9297 66.23%,
        0.9546 69.06%,
        0.9733 72.17%,
        0.9864 75.67%,
        0.9982 83.73%,
        1 100%
      );
      --power-out: linear(
        0 0%,
        0.2342 12.49%,
        0.4374 24.99%,
        0.6093 37.49%,
        0.6835 43.74%,
        0.7499 49.99%,
        0.8086 56.25%,
        0.8593 62.5%,
        0.9023 68.75%,
        0.9375 75%,
        0.9648 81.25%,
        0.9844 87.5%,
        0.9961 93.75%,
        1 100%
      );
      --ease: var(--power-in);
      --trigger-width: 190px;
      --trigger-height: 44px;
    }

    :root:has(:popover-open) {
      --ease: var(--power-out);
    }

    .toc {
      [popover]:popover-open .backdrop-blur {
        scale: 1;
        opacity: 1;
      }

      @starting-style {
        [popover]:popover-open .backdrop-blur {
          scale: 0;
          opacity: 0;
        }
      }

      .trigger {
        width: var(--trigger-width);
        height: var(--trigger-height);
        border-radius: 22px;
        color: light-dark(canvas, canvasText);
        border: 0;
        outline-color: white;
      }

      :root:has(.trigger:focus-visible) [popover] {
        outline: 2px solid white;
      }

      .trigger,
      .contents {
        background: light-dark(hsl(0 0% 8%), hsl(0 0% 14%));
      }

      .contents {
        display: flex;
        overflow: hidden;
        height: 100%;
        width: 100%;
        flex-direction: column-reverse;
        border-radius: 22px;
        padding: 0 6px;
        transition: padding var(--speed);
        transform: translate3d(0, 0, 0);
        @starting-style {
          padding: 1rem;
        }
      }

      @starting-style {
        [popover]:popover-open .contents {
          padding: 0 6px;
        }
      }

      [popover] {
        border: 0px;
        border-radius: 22px;
        background: transparent;
        padding-block: 0;
        overflow: visible;
      }

      [popover] .trigger__details {
        min-height: 44px;
        flex-basis: 44px;
      }

      .trigger__details {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-left: 0.5rem;
        padding-right: 0.25rem;
        width: 100%;
      }

      .trigger__details svg {
        width: 24px;
      }

      .trigger__details .lines {
        animation: draw both linear;
        animation-timeline: --content;
      }

      .trigger__details > span:first-of-type {
        flex: 1;
        display: flex;
        align-items: center;
        text-align: left;
        gap: 0.25rem;

        svg {
          width: 18px;
        }
      }

      @keyframes draw {
        to {
          stroke-dashoffset: 0;
        }
      }

      [popovertargetaction] {
        anchor-name: --opener;
      }

      [popover]:popover-open {
        display: flex;
      }

      [popover]:popover-open .contents {
        padding: 1rem 1rem 0;
      }
      @starting-style {
        [popover]:popover-open .contents {
          padding: 0 6px;
        }
      }

      &[data-alignment="left"] .trigger,
      &[data-alignment="left"] [popover] {
        left: 1rem;
      }

      &[data-alignment="right"] .trigger,
      &[data-alignment="right"] [popover] {
        right: 1rem;
      }

      &[data-alignment="center"] .trigger,
      &[data-alignment="center"] [popover] {
        left: 50%;
        translate: -50% 0;
      }

      [popover] {
        flex-direction: column-reverse;
        position-anchor: --opener;
        transition-property: display, overlay, width, height;
        transition-duration: var(--speed);
        transition-behavior: allow-discrete;
        transition-timing-function: var(--ease);
        color: white;
        margin: unset;
        inset: unset;
        bottom: var(--bottom);
        width: var(--trigger-width);
        height: var(--trigger-height);
        z-index: 99999999;
        padding: 0;
        interpolate-size: allow-keywords;

        @starting-style {
          width: var(--trigger-width);
          height: var(--trigger-height);
        }
      }

      [popover] ol {
        padding-inline: 0.5rem;
        padding-left: 2.5rem;
        list-style: pad-it;
        display: flex;
        width: max-content;
        margin: 0;
        flex-direction: column;
        filter: blur(4px);
        opacity: 0;
        transition:
          filter var(--speed),
          opacity var(--speed);
        transition-timing-function: var(--ease);
      }

      [popover]:popover-open ol {
        filter: blur(0px);
        opacity: 1;
      }

      @starting-style {
        [popover]:popover-open ol {
          filter: blur(4px);
          opacity: 0;
        }
      }

      [popover]:popover-open {
        width: var(--content-width, fit-content);
        height: var(--content-height, fit-content);
      }

      li::marker {
        color: #999;
      }

      li:has(a:is(:hover, :focus-visible))::marker {
        color: #fff;
      }

      ol li button[data-href] {
        white-space: nowrap;
        padding-block: 0.5rem;
        text-decoration: none;
        display: inline-block;
        color: #999;
        flex: 1;
        width: 100%;
        text-align: start;

        &:is(:hover, :focus-visible) {
          color: #fff;
        }
      }

      @starting-style {
        [popover]:popover-open {
          width: var(--trigger-width);
          height: var(--trigger-height);
        }
      }

      [popover]::backdrop {
        transition-property: overlay, display, opacity;
        transition-duration: var(--speed);
        transition-behavior: allow-discrete;
        transition-timing-function: var(--ease);
        background: hsl(0 0% 0% / 0.25);
        opacity: 0;
        backdrop-filter: blur(8px);
      }

      [popover] button {
        background: #0000;
        border: none;
        padding: 0;
        color: inherit;
        cursor: pointer;
      }

      &[data-alignment="right"] [popover]::backdrop {
        mask: linear-gradient(135deg, #0000 0%, #fff 100%);
      }
      &[data-alignment="center"] [popover]::backdrop {
        mask: linear-gradient(180deg, #0000 0%, #fff 100%);
      }
      &[data-alignment="left"] [popover]::backdrop {
        mask: linear-gradient(225deg, #0000 0%, #fff 100%);
      }

      [popover]:popover-open::backdrop {
        opacity: 1;
      }

      @starting-style {
        [popover]:popover-open::backdrop {
          opacity: 0;
        }
      }
    }
  }

  @layer scroll {
    :root {
      timeline-scope: --content;
    }

    html {
      scroll-timeline: --content y;
    }

    @property --progress {
      initial-value: 0;
      syntax: "<integer>";
      inherits: true;
    }

    :root {
      animation: scroll-progress both linear;
      animation-timeline: --content;
    }

    @keyframes scroll-progress {
      to {
        --progress: 100;
      }
    }

    :root {
      counter-reset: progress var(--progress);
    }

    .toc {
      .trigger {
        anchor-name: --opener;
        position: fixed;
        bottom: var(--bottom);
        z-index: 9999999;
        view-transition-name: trigger;
        cursor: pointer;
      }

      .progress {
        border-radius: 100px;
        background: light-dark(hsl(0 0% 35%), hsl(0 0% 0%));
        padding: 0.25rem 0.5rem;
      }

      .progress::before {
        font-variant-numeric: tabular-nums;
        content: counter(progress) "%";
      }
    }
  }

  @layer demo {
    @counter-style pad-it {
      system: extends decimal;
      pad: 2 "0";
    }

    main {
      counter-reset: section;
    }

    section {
      counter-increment: section 1;
    }

    /* h2::before {
      content: counter(section, pad-it) ". ";
    } */

    [id] {
      scroll-margin-top: 80px;
    }

    .toc .heading {
      position: relative;
      display: flex;

      &:is(:hover, :focus-within) button {
        opacity: 1;
      }

      button {
        text-align: left;
        opacity: 0;
        width: 24px;
        aspect-ratio: 1;
        position: absolute;
        right: calc(100% + 0.5rem);
        top: 0;
        display: grid;
        place-items: center;
        transition: opacity 0.2s;
        outline-color: transparent;
        border-radius: 6px;

        &:focus-visible {
          background: color-mix(in hsl, canvasText, #0000 75%);
        }

        svg {
          width: 20px;
        }
      }
    }
  }

  @layer base {
    :root {
      --font-size-min: 14;
      --font-size-max: 16;
      --font-ratio-min: 1.2;
      --font-ratio-max: 1.33;
      --font-width-min: 375;
      --font-width-max: 1280;
    }

    html {
      color-scheme: light dark;
    }

    [data-theme="light"] {
      color-scheme: light only;
    }

    [data-theme="dark"] {
      color-scheme: dark only;
    }

    :where(.fluid) {
      --fluid-min: calc(
        var(--font-size-min) * pow(var(--font-ratio-min), var(--font-level, 0))
      );
      --fluid-max: calc(
        var(--font-size-max) * pow(var(--font-ratio-max), var(--font-level, 0))
      );
      --fluid-preferred: calc(
        (var(--fluid-max) - var(--fluid-min)) /
          (var(--font-width-max) - var(--font-width-min))
      );
      --fluid-type: clamp(
        (var(--fluid-min) / 16) * 1rem,
        ((var(--fluid-min) / 16) * 1rem) -
          (((var(--fluid-preferred) * var(--font-width-min)) / 16) * 1rem) +
          (var(--fluid-preferred) * var(--variable-unit, 100vi)),
        (var(--fluid-max) / 16) * 1rem
      );
      font-size: var(--fluid-type);
    }

    *,
    *:after,
    *:before {
      box-sizing: border-box;
    }

    /* body {
      display: grid;
      place-items: center;
      min-height: 100vh;
      background: light-dark(white, black);
      font-family:
        "SF Pro Text", "SF Pro Icons", "AOS Icons", "Helvetica Neue", Helvetica,
        Arial, sans-serif, system-ui;
    } */

    /* body::before {
      --size: 45px;
      --line: color-mix(in lch, canvasText, transparent 70%);
      content: "";
      height: 100vh;
      width: 100vw;
      position: fixed;
      background:
        linear-gradient(90deg, var(--line) 1px, transparent 1px var(--size)) 50%
          50% / var(--size) var(--size),
        linear-gradient(var(--line) 1px, transparent 1px var(--size)) 50% 50% /
          var(--size) var(--size);
      mask: linear-gradient(-20deg, transparent 50%, white);
      top: 0;
      transform-style: flat;
      pointer-events: none;
      z-index: -1;
    } */
  }

  @counter-style pad-example {
    system: extends decimal;
    suffix: " ";
    pad: 2 " ";
  }
</style>
