<button class="theme-toggle" type="button" aria-label="Toggle theme" transition:persist="theme-toggle">
  <div class="icon-wrapper">
    <svg
      class="icon sun"
      width="20"
      height="20"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <circle cx="12" cy="12" r="4"></circle>
      <line x1="12" y1="2" x2="12" y2="4" style="--i: 0"></line>
      <line x1="19.07" y1="4.93" x2="17.66" y2="6.34" style="--i: 1"></line>
      <line x1="20" y1="12" x2="22" y2="12" style="--i: 2"></line>
      <line x1="17.66" y1="17.66" x2="19.07" y2="19.07" style="--i: 3"></line>
      <line x1="12" y1="20" x2="12" y2="22" style="--i: 4"></line>
      <line x1="6.34" y1="17.66" x2="4.93" y2="19.07" style="--i: 5"></line>
      <line x1="2" y1="12" x2="4" y2="12" style="--i: 6"></line>
      <line x1="4.93" y1="4.93" x2="6.34" y2="6.34" style="--i: 7"></line>
    </svg>
    <svg
      class="icon moon"
      width="20"
      height="20"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
    </svg>
  </div>
</button>

<script>
  import { startViewTransition } from "utils/index.ts";

  function setupThemeToggle() {
    const btn = document.querySelector(".theme-toggle");
    if (!btn) return;

    function toggleTheme() {
      const current = document.documentElement.dataset.theme;
      const next = current === "light" ? "dark" : "light";
      document.documentElement.dataset.theme = next;
      localStorage.setItem("theme", next);
    }

    // 移除旧的监听器（如果存在）
    btn.removeEventListener("click", handleClick);

    function handleClick() {
      startViewTransition(toggleTheme);
    }

    btn.addEventListener("click", handleClick);
  }

  // 初始化
  setupThemeToggle();

  // 监听页面导航事件
  document.addEventListener("astro:page-load", setupThemeToggle);
</script>

<style>
  .theme-toggle {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    border: none;
    background: var(--surface);
    color: var(--muted);
    cursor: pointer;
    padding: 0;
    flex-shrink: 0;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .theme-toggle:hover {
    color: var(--text);
    background: var(--surface-hover);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
  }

  .theme-toggle:active {
    transform: scale(0.95) translateY(0);
    transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .icon-wrapper {
    position: relative;
    width: 20px;
    height: 20px;
  }

  .icon {
    position: absolute;
    top: 0;
    left: 0;
    opacity: 0;
    transform: rotate(180deg) scale(0.8);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .icon.active {
    opacity: 1;
    transform: rotate(0deg) scale(1);
  }

  /* Sun icon rays animation */
  .sun line {
    opacity: 1;
    transition: opacity 0.3s ease;
    transition-delay: calc(var(--i) * 0.05s);
  }

  .theme-toggle:hover .sun line {
    animation: fadeInRay 0.3s ease forwards;
    animation-delay: calc(var(--i) * 0.05s);
  }

  /* Moon icon wiggle animation */
  .theme-toggle:hover .moon {
    animation: moonWiggle 0.6s ease-in-out;
  }

  @keyframes fadeInRay {
    0%,
    50% {
      opacity: 0;
    }
    100% {
      opacity: 1;
    }
  }

  @keyframes moonWiggle {
    0%,
    100% {
      transform: rotate(0deg);
    }
    15% {
      transform: rotate(-12deg);
    }
    30% {
      transform: rotate(12deg);
    }
    45% {
      transform: rotate(-8deg);
    }
    60% {
      transform: rotate(8deg);
    }
    75% {
      transform: rotate(-4deg);
    }
    90% {
      transform: rotate(4deg);
    }
  }

  /* Dark mode (default): show sun icon to switch to light */
  :root:not([data-theme="light"]) .sun,
  :root[data-theme="light"] .moon {
    opacity: 1;
    transform: rotate(0deg) scale(1);
  }
</style>
