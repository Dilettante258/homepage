---
title: äº†è§£ React18 Concurrentæ¸²æŸ“
description: æ·±å…¥ç†è§£ React 18 å¹¶å‘æ¸²æŸ“æœºåˆ¶ï¼ŒåŒ…æ‹¬æ—¶é—´åˆ‡ç‰‡ã€ä¼˜å…ˆçº§è°ƒåº¦ã€Tearing é—®é¢˜ä»¥åŠ useSyncExternalStore çš„åŸç†ä¸æºç åˆ†æã€‚
date: 2025-07-17
locale: zh
tags: [React]
slug: react18-concurrent
---

> é¢å‘è¯»è€…ï¼šå¯¹ReactåŸç†ã€å‰ç«¯å¼€å‘æœ‰ä¸€å®šäº†è§£å’Œç»éªŒçš„äººç¾¤ï¼Œæ‰€ä»¥ä¸€äº›æ¦‚å¿µå’ŒçŸ¥è¯†ä¼šé»˜è®¤è¯»è€…å·²äº†è§£ï¼Œä¸ä¼šè¯¦ç»†è®ºè¿°ã€‚

åœ¨React 18ä¹‹å‰ï¼ŒReacté»˜è®¤ä½¿ç”¨åŒæ­¥æ¸²æŸ“ã€‚æ›´æ–°çš„æ¸²æŸ“åœ¨ä¸€ä¸ªå•ä¸€ã€ä¸é—´æ–­çš„åŒæ­¥äº‹åŠ¡ä¸­å®Œæˆã€‚ä½¿ç”¨åŒæ­¥æ¸²æŸ“ï¼Œä¸€æ—¦æ›´æ–°å¼€å§‹æ¸²æŸ“ï¼Œåœ¨ç”¨æˆ·çœ‹åˆ°ç»“æœä¹‹å‰ï¼Œä»»ä½•æ“ä½œéƒ½æ— æ³•ä¸­æ–­æ¸²æŸ“ã€‚

React 18å¸¦æ¥äº†å¹¶å‘æ¸²æŸ“ï¼Œå®ƒçš„ä¸€ä¸ªå…³é”®ç‰¹æ€§æ˜¯æ¸²æŸ“å¯ä¸­æ–­ã€‚React å¯èƒ½ä¼šå¼€å§‹æ¸²æŸ“æ›´æ–°ï¼Œä¸­é€”æš‚åœï¼Œç„¶åç¨åç»§ç»­ã€‚å®ƒç”šè‡³å¯èƒ½å®Œå…¨æ”¾å¼ƒæ­£åœ¨è¿›è¡Œçš„æ¸²æŸ“ã€‚React ä¿è¯å³ä½¿æ¸²æŸ“ä¸­æ–­ï¼ŒUI ä¹Ÿèƒ½ä¿æŒä¸€è‡´æ€§ã€‚ä¸ºæ­¤ï¼Œå®ƒä¼šç­‰åˆ°æ¸²æŸ“ç»“æŸï¼Œå³æ•´ä¸ªæ ‘éƒ½è¯„ä¼°å®Œæ¯•åï¼Œå†æ‰§è¡Œ DOM ä¿®æ”¹ã€‚å€ŸåŠ©æ­¤åŠŸèƒ½ï¼ŒReact å¯ä»¥åœ¨åå°å‡†å¤‡æ–°çš„å±å¹•ï¼Œè€Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚è¿™æ„å‘³ç€å³ä½¿ UI æ­£åœ¨æ‰§è¡Œå¤§å‹æ¸²æŸ“ä»»åŠ¡ï¼Œå®ƒä¹Ÿèƒ½ç«‹å³å“åº”ç”¨æˆ·è¾“å…¥ï¼Œä»è€Œæ‰“é€ æµç•…çš„ç”¨æˆ·ä½“éªŒã€‚

<https://react.dev/blog/2022/03/29/react-v18#what-is-concurrent-react>

> å¹¶å‘æ›´æ–°æœºåˆ¶æœ¬è´¨ä¸Šæ˜¯æ—¶é—´åˆ‡ç‰‡ï¼Œå¹¶ä¸”é«˜ä¼˜å…ˆçº§ä¼šæ‰“æ–­ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚åœ¨æ¸²æŸ“çš„è¿‡ç¨‹ä¸­ï¼Œç”±äºæ•´ä¸ªè¿ç»­ä¸æ–­çš„æ¸²æŸ“è¿‡ç¨‹æ‹†åˆ†æˆäº†ä¸€ä¸ªä¸ªåˆ†ç‰‡çš„æ¸²æŸ“ç‰‡æ®µï¼Œå› æ­¤åœ¨æ¸²æŸ“çš„é—´éš™æ—¶å°±æœ‰æœºä¼šå»å“åº”ç”¨æˆ·çš„æ“ä½œã€‚è€Œå…·ä½“æ—¶é—´ç‰‡ä¸Šæ‰§è¡Œå“ªä¸ªä»»åŠ¡æ˜¯ç”±ä»»åŠ¡ä¸Šçš„ç›¸å…³**ä¼˜å…ˆçº§**å†³å®šçš„ï¼Œå½“é«˜ä¼˜å…ˆçº§çš„æ›´æ–°åˆ°æ¥æ—¶ï¼Œä¼šä¸­æ–­æ—§çš„æ›´æ–°ï¼Œä¼˜å…ˆæ‰§è¡Œé«˜ä¼˜å…ˆçº§æ›´æ–°ï¼Œå¾…å®Œæˆåç»§ç»­æ‰§è¡Œä½ä¼˜å…ˆçº§æ›´æ–°ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªç®€å•ä¾‹å­çš„å¯¹æ¯”ï¼ˆæœ¬æ–‡æ¡£ä¸­çš„ç¤ºä¾‹ä¸€èˆ¬é‡‡ç”¨äº†ç±»ä¼¼ `while (performance.now() - now < 100) `è¿™æ ·çš„å¾ªç¯ä»£ç æ¥æ¨¡æ‹Ÿäº†ç»„ä»¶å¡é¡¿çŠ¶æ€ï¼‰ï¼Œä»£ç ï¼š[è¢«æ’•ç¢çš„React - æ˜é‡‘](https://juejin.cn/post/7423359941854412851#heading-1)

| **Synchronous**ï¼ˆğŸš§å¡é¡¿ï¼‰                                                                                                                                                                                                                                                                                                                                                                                                                                          | **Concurrent Mode**ï¼ˆğŸ‚ä¸æ»‘ï¼‰                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| ![](https://h-r2.kairi.cc/react18-concurrent-01.awebp)ç”¨æˆ·çš„è¾“å…¥ç”±äºå—åˆ°äº†ç»„ä»¶è¾ƒå¤§çš„æ¸²æŸ“å¼€é”€ï¼Œå› æ­¤äº¤äº’å‡ºç°äº†æ˜æ˜¾çš„**å¡é¡¿ç°è±¡**ã€‚ | ![](https://h-r2.kairi.cc/react18-concurrent-02.awebp)ä¸‹æ–¹çš„Heavyå±•ç¤ºçš„æ˜¯ç»è¿‡äº† `useDeferredValue`åŒ…è£¹çš„å€¼ã€‚ä»å›¾ç‰‡å¯ä»¥æ˜æ˜¾æ„Ÿå—åˆ°ä½“éªŒæµç•…äº†å¾ˆå¤šã€‚ |

è¿™ç§**æ¸²æŸ“å¯ä¸­æ–­**çš„ç‰¹æ€§å¿…é¡»åœ¨ä½¿ç”¨åˆ°ç‰¹å®šçš„APIæ—¶ï¼Œæ‰èƒ½ä½“éªŒåˆ°ã€‚ä»¥å³å›¾ä¸ºä¾‹ï¼š

```tsx
import { useState, useDeferredValue, memo } from 'react';

function Heavy({ value }: { value: string }) {
  const start = performance.now();
  while (performance.now() - start < 300) {}
  return <span>Heavy: {value}</span>;
}
const HeavyMemo = memo(Heavy);

export default function App() {
  const [value, setValue] = useState('');
  const deferredValue = useDeferredValue(value);

  return (
    <div>
      <input value={value} onChange={e => setValue(e.target.value)} /><br/>
      <HeavyMemo value={deferredValue} />
    </div>
  );
}
```

åœ¨æ²¡æœ‰ä½¿ç”¨`useDeferredValue`ä¹‹å‰ï¼Œæ¯å½“ä½ åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥å†…å®¹æ—¶ï¼Œ`HeavyMemo`éƒ½ä¼šæ”¶åˆ°æ–°çš„ propsï¼Œå¹¶é‡æ–°æ¸²æŸ“æ•´ä¸ªç»„ä»¶ï¼Œè¿™ä¼šè®©è¾“å…¥æ„Ÿè§‰å¾ˆå¡é¡¿ã€‚

`useDeferredValue`æ˜¯ React æä¾›çš„ç”¨äºæ€§èƒ½ä¼˜åŒ–çš„ hookï¼Œå®ƒå°†ä¸€ä¸ªå€¼æ ‡è®°ä¸ºå¯ä»¥å»¶è¿Ÿæ›´æ–°ï¼ˆå¦‚ä½•æ ‡è®°çš„ï¼Ÿæ–‡ç« åé¢ä¼šè®²è¿°ï¼‰ï¼Œè®© React å…ˆå¤„ç†æ›´ç´§æ€¥çš„ä»»åŠ¡ï¼Œå¦‚ç”¨æˆ·äº¤äº’å¼•èµ·çš„ç•Œé¢æ›´æ–°ç­‰ã€‚

åœ¨Appç»„ä»¶çš„é¡¶å±‚è°ƒç”¨`useDeferredValue`ï¼Œè·å–`value`çš„å»¶è¿Ÿç‰ˆæœ¬ã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼ŒReact ä¼šä¼˜å…ˆæ›´æ–°è¾“å…¥æ¡†ï¼ˆå¿…é¡»å¿«é€Ÿï¼‰ï¼Œè€Œä¸æ˜¯æ›´æ–°`HeavyMemo`ï¼ˆæ¢å¥è¯è¯´ï¼Œå…è®¸è¾ƒæ…¢é€Ÿåº¦åœ°æ›´æ–°å®ƒï¼‰ï¼Œè¿™é˜²æ­¢äº†`HeavyMemo`é˜»å¡ UI çš„å…¶ä½™éƒ¨åˆ†ã€‚è¿™ä¸ä¼šåŠ å¿«`HeavyMemo`çš„é‡æ–°æ¸²æŸ“é€Ÿåº¦ã€‚ä½†æ˜¯ï¼Œå®ƒå‘Šè¯‰ Reactï¼Œå¯ä»¥é™ä½`HeavyMemo`é‡æ–°æ¸²æŸ“çš„ä¼˜å…ˆçº§ï¼Œä»¥å…é˜»å¡é”®ç›˜è¾“å…¥ã€‚åˆ—è¡¨å°†â€œæ»åâ€äºè¾“å…¥ï¼Œç„¶åâ€œèµ¶ä¸Šâ€ã€‚

å»¶è¿Ÿçš„â€œåå°â€æ¸²æŸ“æ˜¯å¯ä¸­æ–­çš„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ å†æ¬¡åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥å†…å®¹ï¼ŒReact å°†æ”¾å¼ƒè¯¥æ“ä½œå¹¶ä½¿ç”¨æ–°å€¼é‡æ–°å¼€å§‹ã€‚React å°†å§‹ç»ˆä½¿ç”¨æœ€æ–°æä¾›çš„å€¼ã€‚è€Œä¹‹å‰ç‰ˆæœ¬çš„ReactåŒæ­¥æ¸²æŸ“æ—¶ï¼Œç»„ä»¶ä»¥ä¸å¯ä¸­æ–­çš„æ–¹å¼æ¸²æŸ“ï¼Œç›´åˆ°æ¸²æŸ“å®Œæˆï¼ŒUIæ‰ä¼šæ›´æ–°ã€‚ä¸€æ—¦ç»„ä»¶è€—æ—¶è¾ƒé•¿ï¼Œç”¨æˆ·çš„äº¤äº’äº§ç”Ÿçš„æ•ˆæœï¼Œåœ¨æ¸²æŸ“å®Œæˆä¹‹å‰éƒ½æ˜¯ä¸å¯è§çš„ï¼Œå› è€Œå¡é¡¿ã€‚

#### **`useDeferredValue`** **ä¸é˜²æŠ–å’ŒèŠ‚æµï¼Ÿ**

é˜²æŠ–å’ŒèŠ‚æµæ˜¯ JavaScript ä¸­å¸¸ç”¨çš„å‡½æ•°è°ƒç”¨é¢‘ç‡æ§åˆ¶æ‰‹æ®µã€‚ä¸€äº›æƒ…å†µä¸‹ï¼Œé˜²æŠ–å’ŒèŠ‚æµèƒ½å¤Ÿå®Œå…¨è¢«`useDeferredValue`ç»™æ›¿ä»£äº†ï¼Œæˆ–è€…å¯ä»¥ç»“åˆä½¿ç”¨ã€‚

`useDeferredValue`ä¸éœ€è¦é€‰æ‹©å›ºå®šçš„å»¶è¿Ÿï¼Œåå°æ¸²æŸ“çš„æ—¶é—´å°±æ˜¯ä»–çš„å»¶è¿Ÿã€‚æ€§èƒ½å¼ºçš„è®¾å¤‡æ¸²æŸ“å‡ ä¹ç«‹å³å‘ç”Ÿä¸”ä¸å¼•äººæ³¨æ„ï¼Œæ€§èƒ½å·®çš„è®¾å¤‡åˆ™ä¼šâ€œæ»åâ€è¾“å…¥ã€‚

`useDeferredValue`çš„å»¶è¿Ÿé‡æ–°æ¸²æŸ“æ˜¯å¯ä¸­æ–­çš„ã€‚è‹¥ React æ­£åœ¨é‡æ–°æ¸²æŸ“å¤§å‹åˆ—è¡¨æ—¶ç”¨æˆ·å†æ¬¡æŒ‰é”®ï¼ŒReact ä¼šæ”¾å¼ƒæ­¤æ¬¡æ¸²æŸ“ï¼Œå¤„ç†æŒ‰é”®åå†é‡æ–°å¼€å§‹æ¸²æŸ“ï¼Œé¿å…å¡é¡¿ã€‚è€Œé˜²æŠ–å’ŒèŠ‚æµæ˜¯é˜»å¡çš„ï¼Œåªæ˜¯æ¨è¿Ÿäº†æ¸²æŸ“é˜»å¡æŒ‰é”®çš„æ—¶åˆ»ã€‚å¡é¡¿è¿˜æ˜¯ä¼šå‘ç”Ÿï¼Œå‡å¦‚åœ¨åŒæ­¥æ¸²æŸ“çš„æœŸé—´ï¼Œç”¨æˆ·å†æ¬¡æŒ‰é”®ï¼Œè¿˜æ˜¯ä¼šæ„Ÿå—åˆ°å¡é¡¿ã€‚

##### é€‚ç”¨åœºæ™¯

- **useDeferredValue**ï¼šé€‚ç”¨äºä¼˜åŒ– React åº”ç”¨ä¸­çš„æ¸²æŸ“è¿‡ç¨‹ï¼Œå°¤å…¶é€‚ç”¨äºéå…³é”®æ›´æ–°ï¼Œå¦‚éå…³é”®çš„ UI æ›´æ–°ã€æ•°æ®çš„å¼‚æ­¥åŠ è½½ç­‰åœºæ™¯ï¼Œèƒ½è®©åº”ç”¨åœ¨å¤„ç†å®Œæ›´é‡è¦çš„æ›´æ–°åï¼Œå†åˆ©ç”¨ç©ºé—²æ—¶é—´å¤„ç†è¿™äº›è¢«å»¶è¿Ÿçš„æ›´æ–°ã€‚ï¼ˆç½‘ç»œè¯·æ±‚ä¸ä¼šå‡å°‘ï¼ï¼‰
- **é˜²æŠ–å’ŒèŠ‚æµ**ï¼šé€‚ç”¨äºéœ€è¦æ§åˆ¶å‡½æ•°è°ƒç”¨é¢‘ç‡çš„åœºæ™¯ï¼Œå¦‚æœç´¢æ¡†è¾“å…¥è”æƒ³ã€çª—å£å¤§å°è°ƒæ•´ã€æ»šåŠ¨äº‹ä»¶ç›‘å¬ã€é¼ æ ‡ç§»åŠ¨äº‹ä»¶å¤„ç†ç­‰ï¼Œå‡å°‘å‡½æ•°çš„æ‰§è¡Œæ¬¡æ•°ï¼Œé™ä½æ€§èƒ½å¼€é”€ã€‚æ­¤å¤–ï¼Œå®ƒä»¬ä¹Ÿå¯ä»¥ç”¨äºå‡å°‘ç½‘ç»œè¯·æ±‚æ•°é‡ç­‰éæ¸²æŸ“è¿‡ç¨‹çš„ä¼˜åŒ–ã€‚ **ï¼ˆæ€»ç»“ï¼šéœ€æ±‚ä¼˜åŒ–çš„å·¥ä½œå¹¶éåœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­å‘ç”Ÿï¼‰**

##### `useDeferredValue`çš„ç»„ä»¶ä¼šè¢«æ°¸è¿œæ‰“æ–­å—ï¼Ÿ

ä¸ä¼šã€‚è¿™ä¸ªå¯ä»¥ç§°ä½œâ€œä»»åŠ¡é¥¥é¥¿é—®é¢˜â€ã€‚

> å½“é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ‰§è¡Œå®Œï¼Œå‡†å¤‡æ‰§è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡æ—¶ï¼Œåˆæ’å…¥ä¸€ä¸ªé«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œé‚£ä¹ˆåˆä¼šæ‰§è¡Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œå¦‚æœä¸æ–­æœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ’é˜Ÿæ‰§è¡Œï¼Œé‚£ä¹ˆä½ä¼˜å…ˆçº§ä»»åŠ¡ä¾¿ä¸€ç›´å¾—ä¸åˆ°æ‰§è¡Œï¼Œæˆ‘ä»¬ç§°è¿™ç§ç°è±¡ä¸º**ä»»åŠ¡é¥¥é¥¿é—®é¢˜**ã€‚ï¼ˆå¼•ç”¨[\[11\]](https://bytedance.larkoffice.com/docx/TLxAdCnuYoH5vrxPTGkcyct6nJd#share-JDXydde4IoG5ITx4eV4cBnZAnKd))

ä»»åŠ¡ä¼˜å…ˆçº§æœ€åä¼šäº¤ç”± Scheduler è°ƒåº¦ï¼ŒScheduler é‡‡ç”¨ expirationTime æœºåˆ¶è§£å†³**é¥¥é¥¿é—®é¢˜**ã€‚Transition ä»»åŠ¡å¯¹åº”çš„æ˜¯NormalPriorityï¼Œç›¸åº”çš„è¿‡æœŸæ—¶é—´æ˜¯5ç§’ï¼Œä¹Ÿå°±æ˜¯å¦‚æœ5ç§’åè¿˜æ²¡æœ‰è½®åˆ°å®ƒæ‰§è¡Œï¼Œå°±ä¼šå¯ç”¨åŒæ­¥æ¸²æŸ“æ¨¡å¼ï¼Œè¿›è¡Œæ¸²æŸ“ã€‚

# ä»Tearingé—®é¢˜å…¥æ‰‹

**ç”»é¢æ’•è£‚**ï¼ˆè‹±è¯­ï¼šScreen Tearingï¼‰æ˜¯æ˜¾ç¤ºå™¨æŠŠä¸¤å¸§æˆ–æ›´å¤šå¸§ï¼ˆframeï¼‰åŒæ—¶æ˜¾ç¤ºåœ¨åŒä¸€ç”»é¢ä¸Šçš„ä¸€ä¸ªç°è±¡ã€‚ç”»é¢æ’•è£‚çš„ç›¸å…³è¡¨ç°æˆ‘ä»¬ä¸å†èµ˜è¿°ã€‚åœ¨Reactä¸­ï¼Œä¹Ÿæœ‰ç±»ä¼¼ç”»é¢æ’•è£‚çš„è¿™ç§è¡¨ç°ï¼Œè¿™é‡Œå¼•ç”¨ä¸€å¼ å›¾ç‰‡ï¼ˆç¤ºä¾‹ä½“éªŒé“¾æ¥ï¼š[codesandbox.io/p/sandbox/tâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fcodesandbox.io%2Fp%2Fsandbox%2Ftearing-demo-0ecn6y)ï¼‰ï¼š

![](https://h-r2.kairi.cc/react18-concurrent-03.awebp)

æŒ‰ç†æ¥è¯´ï¼ŒJavaScript æœ¬èº«æ˜¯å•çº¿ç¨‹çš„ï¼Œæœ¬èº«ä¸åº”è¯¥å‡ºç°æ’•è£‚çš„é—®é¢˜ã€‚

è¿™ç§ç°è±¡åªå‡ºç°äºReactçš„ Concurrent æ¨¡å¼ä¸‹ã€‚React 18 çš„å¤§ç‰ˆæœ¬ä¸­ï¼ŒReact é»˜è®¤è½¬ä¸ºäº† Concurrent æ¨¡å¼ã€‚React çš„â€œå¹¶å‘æ¸²æŸ“â€æ¨¡å¼å¯ä»¥æš‚åœæ¸²æŸ“è¿‡ç¨‹ä»¥è®©å…¶ä»–å·¥ä½œè¿›è¡Œã€‚åœ¨è¿™äº›æš‚åœä¹‹é—´ï¼Œæ›´æ–°å¯èƒ½ä¼šæ‚„æ‚„åœ°å‘ç”Ÿï¼Œä»è€Œæ›´æ”¹ç”¨äºæ¸²æŸ“çš„æ•°æ®ï¼Œè¿™å¯èƒ½å¯¼è‡´ UI å¯¹åŒä¸€æ•°æ®æ˜¾ç¤ºä¸¤ä¸ªä¸åŒçš„å€¼ã€‚

å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¹¶å‘æ¸²æŸ“å¯ä»¥å¸¦æ¥ä¸€è‡´çš„ UIï¼Œä½†åœ¨ç‰¹å®šæ¡ä»¶ä¸‹ï¼Œä¹Ÿå­˜åœ¨ä¸€ç§æç«¯æƒ…å†µï¼Œå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚åœ¨ä½¿ç”¨åŸç”Ÿçš„ React setState å’Œ useReducer ç­‰ hook æ—¶æ˜¯æ²¡æœ‰æ’•è£‚é—®é¢˜çš„ï¼Œä½†æ˜¯åœ¨ä¸€äº›çŠ¶æ€åº“å¤–éƒ¨çŠ¶æ€ç®¡ç†ä¸­ï¼ˆä¾‹å¦‚è€ç‰ˆæœ¬çš„ react-redux ä»¥åŠ jotaiï¼‰ï¼Œå°±å¯èƒ½å‡ºç°æ’•è£‚çš„çŠ¶æ€ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå‡è®¾ External Store ï¼ˆå¤–éƒ¨ Storeï¼‰é‡Œçš„ä¸€ä¸ªå€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œç„¶åå¼€å§‹å“åº”å¼åœ°æ›´æ–°ï¼šç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ¸²æŸ“ä¸ºè“è‰²ï¼ˆæ­¤æ—¶ store çš„å€¼ï¼‰ã€‚æ­¤æ—¶å‘ç”Ÿäº†ä¸€äº›äº‹æƒ…ï¼Œå¯¼è‡´å¤–éƒ¨ Store çš„å€¼åˆå˜åŒ–ä¸ºçº¢è‰²ï¼Œä½†åœ¨æ­¤ä¹‹åæ¸²æŸ“çš„ä»»ä½•ç»„ä»¶éƒ½ä¼šè·å¾—å½“å‰å¤–éƒ¨ Store çš„å€¼ï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªã€ç¬¬ä¸‰ä¸ªç»„ä»¶ä¹Ÿå°±æ¸²æŸ“ä¸ºäº†çº¢è‰²ã€‚æ­¤æ—¶ï¼Œâ€œTearingâ€ç°è±¡å°±å‘ç”Ÿäº†ã€‚

![](https://h-r2.kairi.cc/react18-concurrent-04.awebp)

# useSyncExternalStore

`useSyncExternalStore`è¿™ä¸ªHookæ­£æ˜¯ä¸ºäº†å¯¹æŠ—â€œTearingâ€é—®é¢˜ã€‚â€œTearingâ€çš„å¤–åœ¨åŸå› åœ¨äºï¼Œï¼ˆå¤–éƒ¨çš„ï¼‰çŠ¶æ€å¯ä»¥åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­æ›´æ–°ï¼Œè€Œ React å¯¹æ­¤æ¯«ä¸çŸ¥æƒ…ã€‚åè¿‡æ¥è¯´ï¼Œå¦‚æœä½ çš„åº”ç”¨çš„çŠ¶æ€å…¨éƒ¨åœ¨äº React è‡ªèº«ï¼Œä½ ä¸ä¼šé‡åˆ° â€œTearingâ€çš„é—®é¢˜ï¼Œè¿™ä¸€ç‚¹ç”± React æ¥ä¿è¯ã€‚

åé¢`useSyncExternalStore`çš†ç®€ç§°â€œ**uSES**â€ã€‚

> ç»„ä»¶å’Œè‡ªå®šä¹‰ Hooks åœ¨æ¸²æŸ“æ—¶ä¸è®¿é—®å¤–éƒ¨å¯å˜æ•°æ®ï¼Œå¹¶ä¸”ä»…ä½¿ç”¨ React propsã€state æˆ– context ä¼ é€’ä¿¡æ¯ï¼Œå› æ­¤ä¸åº”è¯¥å‡ºç°é—®é¢˜ï¼Œå› ä¸º React åŸç”Ÿåœ°åŒæ—¶å¤„ç†è¿™äº›é—®é¢˜ã€‚- [Concurrent React for Library Maintainers - reactwg/react-18 Discussion](https://github.com/reactwg/react-18/discussions/70) 2021-7-8

æ ¹æ® React 18çš„Release docsï¼šuSES æ˜¯ä¸€ä¸ªæ–°çš„ Hookï¼Œå®ƒå…è®¸ å¤–éƒ¨å­˜å‚¨ æ”¯æŒ _å¹¶å‘è¯»å–_ï¼Œé€šè¿‡ _å¼ºåˆ¶åŒæ­¥å˜æ›´_ çš„æ–¹å¼ ã€‚å®ƒæ¶ˆé™¤äº†åœ¨å®ç°å¯¹å¤–éƒ¨æ•°æ®æºçš„è®¢é˜…æ—¶ä½¿ç”¨ useEffect çš„éœ€è¦ï¼Œå¹¶ä¸”ä½œä¸ºå®ç°å¤–éƒ¨å­˜å‚¨çš„ç¬¬ä¸‰æ–¹åº“çš„æ¨è Hook APIã€‚

- å¤–éƒ¨å­˜å‚¨æŒ‡é™¤å¼€ React æä¾›çš„ stateã€contextã€reducer ä¹‹å¤–çš„æ•°æ®æºï¼Œæ¯”å¦‚ï¼šå…¨å±€å˜é‡ã€DOMã€ localStorage ç­‰ç­‰ã€‚
- åŒæ­¥å˜æ›´æŒ‡ React åœ¨ä¸€æ¬¡æ¸²æŸ“ï¼ˆè¿™é‡Œæ¸²æŸ“æŒ‡ç”Ÿæˆä¸€æ¬¡ React èŠ‚ç‚¹æ ‘çš„è¿‡ç¨‹ï¼‰ä¸­æ˜¯åŒæ­¥å®Œæˆæ¸²æŸ“ï¼ˆå˜æ›´ï¼‰ã€‚
- å¹¶å‘è¯»å–ï¼šè¿™é‡Œçš„å¹¶å‘æ˜¯æŒ‡å¹¶å‘æ¸²æŸ“æ¨¡å¼çš„å¹¶å‘ï¼Œä¿è¯æ•°æ®è¯»å–çš„ä¸€è‡´ï¼Œé˜²æ­¢â€œTearingâ€çš„å‡ºç°ã€‚ ï¼ˆéƒ¨åˆ†å‚è€ƒ[\[7\]](https://bytedance.larkoffice.com/docx/TLxAdCnuYoH5vrxPTGkcyct6nJd#share-E3Sxdo33NoLtN4xbX3scZC2Qnih))

æ‰€ä»¥æ¢å¥è¯è¯´ï¼ŒuSES å…è®¸ç»„ä»¶åœ¨ React 18 çš„ Concurrent æ¨¡å¼ä¸‹å®‰å…¨åœ°æœ‰æ•ˆåœ°è¯»å–ï¼ˆè®¢é˜…ï¼‰å¤–æ¥æ•°æ®æºï¼Œåœ¨æ•°æ®æºå‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œèƒ½å¤Ÿè°ƒåº¦æ›´æ–°ã€‚

å¯èƒ½è¯´çš„è¿˜æ˜¯æœ‰ç‚¹äº‘é‡Œé›¾é‡Œï¼Œæˆ‘ä»¬çœ‹ä¸‹ä¸€èŠ‚çš„æ•ˆæœå¯¹æ¯”ã€‚

# çŠ¶æ€åº“å¯¹æ¯”

è¿™é‡Œä¾æ—§æ˜¯å¼•ç”¨åšå®¢[è¢«æ’•ç¢çš„React - æ˜é‡‘](https://juejin.cn/post/7423359941854412851)é‡Œçš„ä¸€å¼ å›¾ï¼Œä¸€äº›è®¨è®ºåšäº†å¿…è¦çš„å¤åˆ¶ã€‚React 18çš„Concurrent Modeå¯¹äºç¤¾åŒºçš„çŠ¶æ€åº“æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„å˜æ›´ï¼Œä¸€äº›çŠ¶æ€ç®¡ç†åº“éƒ½åšäº†é‡æ„æ¥é€‚é…ï¼Œä¾‹å¦‚[redux@8](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Freduxjs%2Freact-redux%2Freleases%2Ftag%2Fv8.0.0-alpha.0)ã€‚

å¼ºè°ƒä¸€ç‚¹ï¼Œä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œéƒ½ç”¨äº†[startTransition â€“ React](https://link.juejin.cn/?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FstartTransition) æ¥ä¿è¯å¹¶å‘æ›´æ–°ï¼Œçš†ä¸ºè®¡æ•°å™¨ä¾‹å­ï¼Œè¿ç»­ç‚¹å‡»ä¸‰æ¬¡`+1`ã€‚æºä»£ç ï¼š[react tearing in concurrent mode - github gist](https://gist.github.com/rikisamurai/dd07d58d637f9fa2ae225ecffae6ab59)

![](https://h-r2.kairi.cc/react18-concurrent-05.awebp)

| ç”¨æ³•        | useState | useReducer | useSyncExternalStore | zustand | jotai | Redux |
| ----------- | -------- | ---------- | -------------------- | ------- | ----- | ----- |
| æ˜¯å¦å¡é¡¿    | âŒ       | âŒ         | âœ…                   | âœ…      | âŒ    | âœ…    |
| æ˜¯å¦Tearing | âŒ       | âŒ         | âŒ                   | âŒ      | âœ…    | âŒ    |

**æ˜¯å¦å¡é¡¿**ï¼šæŒ‡åœ¨rerenderæ—¶æ˜¯å¦è¿˜èƒ½ç›¸åº”ç”¨æˆ·äº¤äº’ï¼Œæ¯”å¦‚ä¸Šé¢çš„useSyncExternalStoreæˆ–zustandåœ¨ç‚¹å‡»ä¸€æ¬¡åå› ä¸ºrerenderå†æ¬¡ç‚¹å‡»æ—¶å°±ä¼šå¡ä½ï¼ˆå¯ä»¥çœ‹è§æŒ‰é’®ä¸€ç›´å¤„äºpressçš„çŠ¶æ€ï¼‰

**æ˜¯å¦Tearing**ï¼šçŠ¶æ€æ›´æ–°äº§ç”Ÿä¸ä¸€è‡´çš„æƒ…å†µï¼Œæ¯”å¦‚jotaiè¿ç»­ç‚¹å‡»ä¸‰æ¬¡ååŒæ—¶å‡ºç°äº†ä¸åŒvalueçš„çŠ¶æ€å€¼

åœ¨AIPAå®ç°çš„ä¾‹å­ï¼š[React 18 å¹¶å‘æ¸²æŸ“çŠ¶æ€ç®¡ç†æµ‹è¯•](https://react-concurrent.aipa.bytedance.net/) ï¼ˆå¯ä»¥äº²è‡ªä½“éªŒä¸€ä¸‹ï¼Œéœ€å†…ç½‘è®¿é—®ï¼‰

![](https://h-r2.kairi.cc/react18-concurrent-06.awebp)

### uSES å’Œ zustand ä¸ºä»€ä¹ˆä¼šå¡é¡¿ï¼ŸuSES åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ

```tsx
import { startTransition } from 'react';

function Controller() {
  const increment = useStore((state) => state.increment);
  const concurrentAdd = () => startTransition(increment);
  return <button onClick={concurrentAdd}>+1</button>;
}
```

ä»£ç ä¸­ï¼Œstateçš„incrementæ“ä½œä¸æ˜¯ç”¨äº†startTransitionåŒ…è£¹å—ï¼Ÿè¿™ä¸ªçŠ¶æ€å˜æ›´ä¸åº”è¯¥è¢«æ ‡è®°ä¸º Transitionï¼Œç„¶åå¼€å¯å¹¶å‘æ¸²æŸ“ï¼Œä¸ä¼šå¡é¡¿å—ï¼Ÿ

æˆ‘ä»¬æ¥é˜…è¯»æºç ï¼ˆæ¥æº[\[7\]](https://bytedance.larkoffice.com/docx/TLxAdCnuYoH5vrxPTGkcyct6nJd#share-ZYQedSabCoLJ6VxJT0RcRWHknif)ï¼Œ ä½œè€…åªä¿ç•™äº†æ ¸å¿ƒé€»è¾‘ï¼Œç§»é™¤å¼€å‘æ¨¡å¼æ‰“ç‚¹ã€é”™è¯¯å¤„ç†ç­‰æ¬¡è¦çš„å†…å®¹ï¼‰ï¼š

```ts
// ä¸»è¦å®ç°
function mountSyncExternalStore<T>(
  subscribe: (() => void) => () => void,
  getSnapshot: () => T,
  getServerSnapshot?: () => T,
): T {
  // å¼•ç”¨çš„å…¨å±€å˜é‡é‡æ–°å£°æ˜ä¸€ä¸‹å†™åœ¨å‡½æ•°æœ€å‰é¢ï¼Œéå¸¸å¥½ä¹ æƒ¯
  const fiber = currentlyRenderingFiber;
  // åŒºåˆ† SSR å’Œ CSR ç¯å¢ƒè·å–ä¸åŒçš„ value
  const nextSnapshot = getIsHydrating() ? getServerSnapshot() : getSnapshot();

  // æŒ‚è½½ä¸€ä¸ª hook æ¥å¤„ç† ExternalStore
  const hook = mountWorkInProgressHook();

  hook.memoizedState = nextSnapshot;
  const inst: StoreInstance<T> = {
    value: nextSnapshot,
    // å­˜ä¸€ä¸‹ getSnapShot æ–¹æ³•æœ¬èº«ä¸ºäº†åç»­æ›´æ–°æ—¶
    // ä¹Ÿæ£€æŸ¥ getSnapshot æ˜¯å¦å˜æ›´
    getSnapshot,
  };
  hook.queue = inst;

  // æŒ‚è½½ä¸€ä¸ª effect æ¥è®¢é˜… store å˜æ›´
  mountEffect(subscribeToStore.bind(null, fiber, inst, subscribe), [subscribe]);

  // Schedule an effect to update the mutable instance fields.
  // We will update this whenever subscribe, getSnapshot, or value changes.
  // Because there's no clean-up function, and we track the deps correctly,
  // we can call pushEffect directly, without storing any additional state.
  // For the same reason, we don't need to set a static flag, either.
  pushEffect(
    HookHasEffect | HookPassive,
    updateStoreInstance.bind(null, fiber, inst, nextSnapshot, getSnapshot),
    undefined,
    null,
  );

  return nextSnapshot;
}

// è®¢é˜… store å˜æ›´çš„å®ç°
function subscribeToStore<T>(fiber, inst: StoreInstance<T>, subscribe) {
  const handleStoreChange = () => {
    // The store changed. Check if the snapshot changed since the last time we
    // read from the store.
    if (checkIfSnapshotChanged(inst)) {
      // Force a re-render.
      forceStoreRerender(fiber);
    }
  };
  // Subscribe to the store and return a clean-up function.
  return subscribe(handleStoreChange);
}

// æ£€æŸ¥æ˜¯å¦è¦è§¦å‘æ›´æ–°
function checkIfSnapshotChanged<T>(inst: StoreInstance<T>): boolean {
  const latestGetSnapshot = inst.getSnapshot;
  const prevValue = inst.value;
  try {
    const nextValue = latestGetSnapshot();
    return !is(prevValue, nextValue); // è¿™é‡Œçš„ is æ˜¯ object-isï¼Œä»…ä½œå¼•ç”¨æ¯”è¾ƒã€‚
  } catch (error) {
    return true;
  }
}

// æ›´æ–° store çš„å€¼
function updateStoreInstance<T>(
  fiber: Fiber,
  inst: StoreInstance<T>,
  nextSnapshot: T,
  getSnapshot: () => T,
) {
  // These are updated in the passive phase
  inst.value = nextSnapshot;
  inst.getSnapshot = getSnapshot;

  // Something may have been mutated in between render and commit. This could
  // have been in an event that fired before the passive effects, or it could
  // have been in a layout effect. In that case, we would have used the old
  // snapshot and getSnapshot values to bail out. We need to check one more time.
  if (checkIfSnapshotChanged(inst)) {
    // Force a re-render.
    forceStoreRerender(fiber);
  }
}

function forceStoreRerender(fiber) {
  const root = enqueueConcurrentRenderForLane(fiber, SyncLane);
  if (root !== null) {
    // è¿™é‡Œä¼ å…¥ SyncLane æ¥åŒºåˆ†è¿™æ¬¡æ›´æ–°æ˜¯åŒæ­¥æ›´æ–°
    scheduleUpdateOnFiber(root, fiber, SyncLane, NoTimestamp);
  }
}
```

React æ–‡æ¡£ä¸­è¿™ä¹ˆè¯´ï¼ˆæ¥æº[\[10\]](https://bytedance.larkoffice.com/docx/TLxAdCnuYoH5vrxPTGkcyct6nJd#share-IIYxde4TOoXtZfxZpEncHsrynhe)ï¼‰ï¼šå¦‚æœåœ¨éé˜»å¡ Transition æ›´æ–°æœŸé—´ store å‘ç”Ÿçªå˜ï¼ŒReact å°†å›é€€åˆ°ä»¥é˜»å¡æ–¹å¼æ‰§è¡Œè¯¥æ›´æ–°ã€‚å…·ä½“æ¥è¯´ï¼Œå¯¹äºæ¯æ¬¡è°ƒç”¨çš„ Transition æ›´æ–°ï¼ŒReact éƒ½ä¼šåœ¨å°†æ›´æ”¹åº”ç”¨äº DOM ä¹‹å‰å†æ¬¡è°ƒç”¨`getSnapshot`ã€‚å¦‚æœè¿”å›çš„å€¼ä¸åˆå§‹è°ƒç”¨æ—¶çš„ä¸åŒï¼ŒReact å°†ä»å¤´å¼€å§‹é‡æ–°æ‰§è¡Œæ›´æ–°ï¼Œè¿™æ¬¡å°†å…¶ä½œä¸ºé˜»å¡æ›´æ–°åº”ç”¨ï¼Œä»¥ç¡®ä¿å±å¹•ä¸Šçš„æ¯ä¸ªç»„ä»¶éƒ½åæ˜ ç›¸åŒç‰ˆæœ¬çš„ storeã€‚å…¶å®å°±æ˜¯å¯¹ä¸Šé¢è¿™æ®µä»£ç çš„è§£é‡Šã€‚

![](https://h-r2.kairi.cc/react18-concurrent-07.awebp)

ç»“åˆä¸Šé¢çš„ä¾‹å­è®²è§£ï¼š

- å½“ç»„ä»¶é¦–æ¬¡ä½¿ç”¨ uSES è®¢é˜… store æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œç±»ä¼¼ä¸Šé¢ä»£ç ä¸­çš„ mountSyncExternalStore å‡½æ•°ã€‚å®ƒä¼šè·å–åˆå§‹çŠ¶æ€ï¼Œå¦‚æœæ˜¯æœåŠ¡å™¨ç«¯æ¸²æŸ“ç¯å¢ƒï¼ˆgetIsHydrating() ä¸º trueï¼‰ï¼Œåˆ™ä½¿ç”¨ getServerSnapshot() è·å–æœåŠ¡å™¨ç«¯çš„å¿«ç…§ï¼›å¦‚æœæ˜¯å®¢æˆ·ç«¯æ¸²æŸ“ï¼Œåˆ™ä½¿ç”¨ getSnapshot() è·å–å®¢æˆ·ç«¯çš„å½“å‰çŠ¶æ€ã€‚
- åŒæ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª inst å®ä¾‹ 16è¡Œï¼Œå­˜å‚¨ valueï¼ˆå½“å‰SnapshotçŠ¶æ€ï¼‰å’Œ getSnapshot å‡½æ•°æœ¬èº«ï¼Œç”¨äºåç»­çš„æ¯”è¾ƒå’Œæ›´æ–°æ“ä½œã€‚
- ç¬¬ä¸€æ¬¡ç‚¹å‡» `+1` æŒ‰é’®åï¼Œ`startTransition(increment)`å¼€å¯äº†ä¸€æ¬¡ Transition æ›´æ–°ï¼ˆæ­¤æ—¶è¿˜æ˜¯éé˜»å¡æ€§è´¨çš„ï¼‰
- å½“å¤„äºéé˜»å¡çš„ Transition æ›´æ–°æœŸé—´ï¼Œç»„ä»¶çš„æ›´æ–°æ“ä½œä¼šè¢«æ¨è¿Ÿã€‚ä½†åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¦‚æœ store å‘ç”Ÿçªå˜ï¼ˆä¾‹å¦‚é€šè¿‡å¤–éƒ¨æ“ä½œä¿®æ”¹äº† store çš„çŠ¶æ€ï¼‰ï¼Œ43è¡Œ `subscribeToStore` å‡½æ•°çš„ 44è¡Œ `handleStoreChange` å›è°ƒä¼šè¢«è§¦å‘ã€‚
- `handleStoreChange` ä¼šè°ƒç”¨ 57è¡Œ `checkIfSnapshotChanged` å‡½æ•°æ¥æ£€æŸ¥çŠ¶æ€æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ã€‚å®ƒä¼šä½¿ç”¨æœ€æ–°çš„ `getSnapshot` å‡½æ•°è·å–æ–°çš„å€¼ï¼Œå¹¶ä¸ä¹‹å‰çš„ valueï¼ˆå­˜æ”¾åœ¨ `inst.value`ï¼‰ è¿›è¡Œæ¯”è¾ƒã€‚è¿™é‡Œçš„æ¯”è¾ƒæ˜¯é€šè¿‡ object - isï¼ˆå³ is å‡½æ•°ï¼‰è¿›è¡Œçš„å¼•ç”¨æ¯”è¾ƒï¼Œå¦‚æœå‘ç°å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œå°±ä¼šè°ƒç”¨ 89è¡Œ `forceStoreRerender` å‡½æ•°å¼ºåˆ¶é‡æ–°æ¸²æŸ“ç»„ä»¶ã€‚
- åœ¨ 89è¡Œ `forceStoreRerender` å‡½æ•°ä¸­ï¼Œä¼šè°ƒç”¨ `enqueueConcurrentRenderForLane` å‡½æ•°æ¥å°†æ›´æ–°æ”¾å…¥æ›´æ–°é˜Ÿåˆ—ï¼Œå¹¶ä¸”æŒ‡å®šæ›´æ–°çš„ä¼˜å…ˆçº§ï¼ˆ**SyncLane è¡¨ç¤ºåŒæ­¥ä¼˜å…ˆçº§**ï¼Œè™½ç„¶ å› ä¸ºåœ¨éé˜»å¡ Transition æ›´æ–°æœŸé—´ï¼Œæ•´ä½“æ›´æ–°æ˜¯è¢«æ¨è¿Ÿçš„ï¼Œä½† store çš„çªå˜æ›´æ–°æ˜¯éœ€è¦åŠæ—¶å¤„ç†çš„ï¼‰ã€‚
- ç„¶åï¼Œä¼šè°ƒç”¨ 93è¡Œ `scheduleUpdateOnFiber` å‡½æ•°æ¥è®¡åˆ’è¿™ä¸ªæ›´æ–°ã€‚React çš„æ›´æ–°è°ƒåº¦æœºåˆ¶ä¼šæ ¹æ®ä¼˜å…ˆçº§æ¥å®‰æ’è¿™äº›æ›´æ–°çš„æ‰§è¡Œé¡ºåºã€‚
- Transition æ›´æ–°è™½ç„¶æ•´ä½“æ˜¯éé˜»å¡çš„ï¼Œä½†å¦‚æœåœ¨æœŸé—´å‘ç”Ÿäº† store çš„çªå˜ï¼Œè¿™ä¸ªçªå˜æ›´æ–°ä¼šè¢«æ ‡è®°ä¸ºé«˜ä¼˜å…ˆçº§ï¼ˆSyncLaneï¼‰ï¼Œä»è€Œåœ¨åˆé€‚çš„æ—¶æœºï¼ˆé€šå¸¸æ˜¯åœ¨ç´§æ€¥æ›´æ–°å¤„ç†ä¹‹åï¼‰å°½å¿«æ‰§è¡Œã€‚
- åœ¨æ¸²æŸ“é˜¶æ®µå®Œæˆåï¼Œä¼šè¿›å…¥è¢«åŠ¨æ›´æ–°é˜¶æ®µã€‚è¿™æ—¶ï¼Œ34è¡Œ pushEffect å‡½æ•°æ·»åŠ çš„ `updateStoreInstance` ä½œä¸ºè¢«åŠ¨ effect ä¼šè¢«æ‰§è¡Œã€‚
- 69è¡Œ `updateStoreInstance` ä¼šæ›´æ–° inst å®ä¾‹çš„ value å’Œ getSnapshot å±æ€§ã€‚å®ƒä¼šå…ˆå°†æ–°çš„çŠ¶æ€å€¼ nextSnapshot å’Œæ–°çš„ getSnapshot å‡½æ•°èµ‹å€¼ç»™ instã€‚ç„¶åå†è°ƒç”¨ 57è¡Œ `checkIfSnapshotChanged` å‡½æ•°å†æ¬¡æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–ï¼Œå› ä¸ºæœ‰å¯èƒ½åœ¨æ¸²æŸ“é˜¶æ®µå’Œè¢«åŠ¨æ•ˆæœé˜¶æ®µä¹‹é—´ store çš„çŠ¶æ€åˆè¢«ä¿®æ”¹äº†ã€‚å¦‚æœå‘ç°è¿˜æœ‰å˜åŒ–ï¼Œå°±å†æ¬¡è°ƒç”¨ 89è¡Œ `forceStoreRerender` å‡½æ•°æ¥ç¡®ä¿ç»„ä»¶èƒ½å¤Ÿæ­£ç¡®åœ°å“åº” store çš„å˜åŒ–ã€‚
- æ‰€ä»¥ç®€å•æ¥è¯´ï¼Œ ç¬¬äºŒæ¬¡ã€ç¬¬ä¸‰æ¬¡çš„ç‚¹å‡»éƒ½æ˜¯åœ¨æ¸²æŸ“æœŸé—´å‘ç”Ÿçš„ï¼Œä¼šé€ æˆstoreçš„å˜æ›´ï¼Œç¬¬ä¸€æ¬¡æ¸²æŸ“å®Œæˆåï¼ŒReact ä¼šåœ¨å°†æ›´æ”¹åº”ç”¨äº DOM ä¹‹å‰å†æ¬¡è°ƒç”¨`getSnapshot`ã€‚å¦‚æœè¿”å›çš„å€¼ä¸åˆå§‹è°ƒç”¨æ—¶çš„ä¸åŒï¼ŒReact å°†ä»å¤´å¼€å§‹é‡æ–°æ‰§è¡Œæ›´æ–°ï¼Œè¿™æ¬¡å°†å…¶ä½œä¸ºé˜»å¡æ›´æ–°åº”ç”¨ï¼Œä»¥ç¡®ä¿å±å¹•ä¸Šçš„æ¯ä¸ªç»„ä»¶éƒ½åæ˜ ç›¸åŒç‰ˆæœ¬çš„ storeã€‚
- æœ€ç»ˆï¼Œ`scheduleUpdateOnFiber`ä¼š **è½¬åˆ°scheduleUpdateOnFiber** æ–¹æ³•ä¸­ï¼Œæ£€æµ‹æ›´æ–°ä¼˜å…ˆçº§ä¸º **SyncLane** ï¼Œï¼ˆâ€¦â€¦å…¶ä»–æ¡ä»¶ã€ä¸­é—´è¿‡ç¨‹çœç•¥ï¼‰ï¼Œç„¶å**performSyncWorkOnRoot** è¿›è¡ŒåŒæ­¥æ¸²æŸ“æ›´æ–°ï¼Œæ­¤æ—¶æ¸²æŸ“æ˜¯åŒæ­¥ä¸å¯ä¸­æ–­çš„ã€‚

Reactå›¢é˜Ÿæ­£åœ¨é‡æ–°å®¡è§†ï¼Œè®¡åˆ’ä½¿ç”¨`use` APIåŸç”Ÿæ”¯æŒå¹¶å‘å¤–éƒ¨å­˜å‚¨ã€‚ç›®æ ‡æ˜¯å…è®¸åœ¨æ¸²æŸ“æœŸé—´è¯»å–å¤–éƒ¨çŠ¶æ€è€Œä¸ä¼šæ’•è£‚ï¼Œå¹¶ä¸ React æä¾›çš„æ‰€æœ‰å¹¶å‘åŠŸèƒ½æ— ç¼åä½œã€‚<https://react.dev/blog/2025/04/23/react-labs-view-transitions-activity-and-more#concurrent-stores>

**zustand**ä¹Ÿæ˜¯é‡‡ç”¨useSyncExternalStoreï¼Œå› æ­¤å’ŒuseSyncExternalStoreä¸€æ ·ä¼šå¡é¡¿ï¼ˆå¯ä»¥é‡‡ç”¨ [use-zustand](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzustandjs%2Fuse-zustand) æ¥è§£å†³ï¼Œä½†ä¼šå‘ç”ŸTearingï¼‰ã€‚**react-redux**åœ¨[8.0](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Freduxjs%2Freact-redux%2Freleases%2Ftag%2Fv8.0.0-alpha.0)é‡‡ç”¨äº†useSyncExternalStoreè¿›è¡Œäº†é‡æ„ï¼Œå› æ­¤åŒæ ·ä¹Ÿä¼šå‘ç”Ÿå¡é¡¿ã€‚å› æ­¤é‡‡ç”¨useSyncExternalStoreå®ç°çš„ä¸€äº›çŠ¶æ€åº“æ— æ³•äº«å—åˆ° Concurrent Mode çš„å¥½å¤„

### Jotaiä¸ºä»€ä¹ˆä¼šå¯¼è‡´Tearing

> è¯¥å°èŠ‚ç›´æ¥å‚è€ƒ[\[2\]](https://bytedance.larkoffice.com/docx/TLxAdCnuYoH5vrxPTGkcyct6nJd#share-OWVTdZTeUoLnmKx9V5Ocz16wn55)

ä»ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°Concurrent Modeä¸‹ç®€å•ä½¿ç”¨ useState æˆ– useReducer æ—¢ä¸ä¼šå¡é¡¿ä¹Ÿä¸ä¼šå‘ç”ŸTearingã€‚ è€ŒJotaiå†…éƒ¨å®ç°é‡‡ç”¨çš„æ˜¯ useReducerï¼Œé‚£ä¸ºä»€ä¹ˆä¹Ÿå¯¼è‡´äº†Tearingå‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºå•ç‹¬ä½¿ç”¨useStateæˆ–useReduceræ˜¯æ²¡é—®é¢˜çš„ï¼Œä½† Jotai é‡‡ç”¨äº† useReducer + useEffect è¿›è¡ŒåŒæ­¥æ›´æ–°è¿™å¯èƒ½ä¼šå¯¼è‡´Tearing

> å‚è€ƒ [jotai/src/react/useAtomValue.ts at main Â· pmndrs/jotai](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpmndrs%2Fjotai%2Fblob%2Fmain%2Fsrc%2Freact%2FuseAtomValue.ts%23L143)
>
> react-redux7ä¹Ÿæ˜¯é‡‡ç”¨çš„ useReducer + useEffectï¼Œå› æ­¤åœ¨concurrentåŒæ ·ä¼šå¯¼è‡´tearingé—®é¢˜ï¼›ä½†å…¶åœ¨react-redux8ä¸­æ›¿æ¢æˆäº†useSyncExternalStoreå› æ­¤ä¸ä¼šå†æœ‰tearingé—®é¢˜ï¼ˆ[release](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Freduxjs%2Freact-redux%2Freleases%2Ftag%2Fv8.0.0-alpha.0)ï¼Œ[PR](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Freduxjs%2Freact-redux%2Fpull%2F1808%2Ffiles%23diff-af3f9a50d6ee93cbd74ce49df9fbc050728add74c7355cc851a0d57d3286d260L70)ï¼‰

Jotai å¯ä»¥å®Œç¾äº«å—åˆ°Concurrent Modeå¸¦æ¥çš„ä¼˜ç‚¹ï¼Œä½†ä¼šå­˜åœ¨ä¸€äº›å¶å‘çš„Tearingç°è±¡ã€‚

> [Why useSyncExternalStore Is Not Used in Jotai Â· Daishi Kato's blog](https://link.juejin.cn?target=https%3A%2F%2Fblog.axlight.com%2Fposts%2Fwhy-use-sync-external-store-is-not-used-in-jotai%2F) Daishiè®¤ä¸ºåœ¨Jotai ä¸­å¯¹ Suspenseå’ŒConcurrentçš„æ”¯æŒå¸¦æ¥çš„å¥½å¤„ èƒ½ç›–è¿‡ temporary tearingçš„ç¼ºç‚¹

Tearingç°è±¡åªæ˜¯æš‚æ—¶çš„ï¼Œæœ€ç»ˆUIæ˜¯ä¼šè¾¾æˆä¸€è‡´ã€‚

# å¯¹æ¯” Synchronous å’Œ Concurrent

| Synchronous                                                                                                                                                                                                                                                                                                                                                                              | Concurrent                                                                                                                                                                                                                                                                                                                                                                                   |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ![](https://h-r2.kairi.cc/react18-concurrent-08.awebp) | ![](https://h-r2.kairi.cc/react18-concurrent-09.awebp) |

å¯ä»¥çœ‹è§ï¼ŒåŒæ­¥æ¨¡å¼ä¸‹çš„è¡¨ç°å’Œ uSES çš„è¡¨ç°åŸºæœ¬ä¸€è‡´ã€‚

å¹¶å‘å¼æ¸²æŸ“æ¥è¯´æ˜¯ä¸€ä¸ªå·¨å¤§çš„å¥½å¤„ï¼Œå› ä¸ºç”¨æˆ·å¯ä»¥ä¸é¡µé¢äº¤äº’ï¼Œè€Œä¸ä¼šè¢« React é˜»å¡ã€‚æœ‰äº†å¹¶å‘æ¸²æŸ“ï¼ŒReact å¯ä»¥è®©ç‚¹å‡»å‘ç”Ÿï¼Œä»è€Œè®©é¡µé¢åœ¨ç”¨æˆ·çœ‹æ¥æµç•…ä¸”å…·æœ‰äº¤äº’æ€§ã€‚

# Concurrent æ¸²æŸ“æ—¶æ€æ ·å¯ä¸­æ–­çš„ï¼Ÿ

å†æ¸©ä¹ ä¸€é **concurrent æ¨¡å¼**çš„ä»‹ç»ï¼š

å½“æœ‰çŠ¶æ€æ›´æ–°æ—¶ï¼Œä¼šä¸ºæ¯ä¸ªæ›´æ–°åˆ†é…ä¼˜å…ˆçº§ï¼Œå½“åœ¨æ›´æ–°çš„è¿‡ç¨‹ä¸­ï¼Œåç»­è¿›å…¥çš„æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡æ—¶ï¼Œä¼šä¸­æ–­å½“å‰ä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œä¼˜å…ˆå»æ‰§è¡Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œå†å»æ‰§è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨æµè§ˆå™¨åˆ·æ–°çš„æ¯å¸§ï¼ˆFrameï¼‰ä¸­ä¼šé¢„ç•™ä¸€å®šçš„å›ºå®šæ—¶é—´è®©æµè§ˆå™¨å»æ¸²æŸ“é¡µé¢ï¼Œè‹¥å½“å‰æ›´æ–°ä»»åŠ¡æ‰€ç”¨æ—¶é—´è¾ƒé•¿ï¼Œå°±ä¼šè¢«ä¸­æ–­ï¼Œæ”¾åˆ°ä¸‹ä¸€å¸§ä¸­ç»§ç»­æ‰§è¡Œã€‚ï¼ˆå‚è€ƒ[\[9\]](https://bytedance.larkoffice.com/docx/TLxAdCnuYoH5vrxPTGkcyct6nJd#share-WZqQdBBV1oW74NxKrWXcCu6NnRc))

![](https://h-r2.kairi.cc/react18-concurrent-10.awebp)

ä¸€ä¸ªæ¯”è¾ƒå¥½çš„å›¾ï¼š

![](https://h-r2.kairi.cc/react18-concurrent-11.awebp)

### React Work Loopï¼ˆå³ä¾§ï¼‰

- performWorkUntilDeadlineï¼ˆæ‰§è¡Œè°ƒåº¦ï¼‰

- startTime = currentTime;ï¼ˆè®°å½•è°ƒåº¦å¼€å§‹æ—¶é—´ï¼‰ï¼šåœ¨æ¯æ¬¡å·¥ä½œå¾ªç¯å¼€å§‹æ—¶ï¼Œè®°å½•å½“å‰æ—¶é—´ï¼ˆ`startTime`ï¼‰ï¼Œç”¨äºåç»­çš„æ—¶é—´ç®¡ç†ã€‚

- workLoopï¼ˆå·¥ä½œå¾ªç¯ï¼‰ï¼šæ ¸å¿ƒå¾ªç¯ï¼Œä¸æ–­ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–æœ€é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡å¹¶æ‰§è¡Œã€‚
  - taskQueueï¼ˆä»»åŠ¡é˜Ÿåˆ—ï¼‰ï¼šå­˜å‚¨å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡æŒ‰ç…§ä¼˜å…ˆçº§è¿›è¡Œæ’åˆ—ã€‚

- currentTask != nullï¼ˆæ˜¯å¦è¿˜æœ‰ä»»åŠ¡ï¼‰ï¼šæ£€æŸ¥å½“å‰æ˜¯å¦æœ‰ä»»åŠ¡éœ€è¦æ‰§è¡Œã€‚
  - å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œè·å–æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡å¹¶æ‰§è¡Œã€‚
  - ä»»åŠ¡é˜Ÿåˆ—å·²ç©ºåˆ™å…³é—­æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»»åŠ¡å·²æ‰§è¡Œå®Œã€‚

- shouldYieldToHostï¼ˆæ˜¯å¦åº”è¯¥è®©æ­¥ç»™å®¿ä¸»ï¼‰ï¼šåˆ¤æ–­å½“å‰ä»»åŠ¡æ‰§è¡Œæ—¶é—´æ˜¯å¦è¶…è¿‡è°ƒåº¦æ—¶é—´ã€‚
  - å¦‚æœæ—¶é—´è¶…è¿‡ï¼Œåˆ™è®©æ­¥ç»™å®¿ä¸»ç¯å¢ƒï¼Œæ³¨å†Œä¸€ä¸ªå®ä»»åŠ¡ï¼Œç­‰å¾…ä¸‹æ¬¡æ‰§è¡Œï¼ˆworkloop è‡ªèº«ï¼‰ã€‚
  - å¦åˆ™ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚

### æµè§ˆå™¨äº‹ä»¶å¾ªç¯çš„å®ä»»åŠ¡è°ƒåº¦ï¼ˆå·¦ä¾§ï¼‰

> è¿™ä¸€éƒ¨åˆ†å¸Œæœ›è¯»è€…äº†è§£æµè§ˆå™¨çš„äº‹ä»¶å¾ªç¯ã€‚

- æ‰§è¡Œå®ä»»åŠ¡
  - JSæ˜¯ä¸€é—¨å•çº¿çš„éé˜»å¡çš„è„šæœ¬è¯­è¨€ï¼ŒJavaScript ä¸»çº¿ç¨‹å’Œæ¸²æŸ“çº¿ç¨‹äº’æ–¥ã€‚

  - å®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ï¼š
    - æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ï¼ˆæ‰§è¡Œæ ˆä¸­æ²¡æœ‰å°±ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ï¼‰ã€‚
    - æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚æœé‡åˆ°å¾®ä»»åŠ¡ï¼Œå°±å°†å®ƒæ·»åŠ åˆ°å¾®ä»»åŠ¡çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚
    - å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œç«‹å³æ‰§è¡Œå½“å‰å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å¾®ä»»åŠ¡ï¼ˆä¾æ¬¡æ‰§è¡Œï¼‰ã€‚

- å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå¼€å§‹æ£€æŸ¥æ¸²æŸ“ï¼Œç„¶åæ¸²æŸ“çº¿ç¨‹æ¥ç®¡è¿›è¡Œæ¸²æŸ“ã€‚ å¦‚æœå®ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ä¼‘çœ ç›´åˆ°å‡ºç°å®ä»»åŠ¡ã€‚

### å…³äº Concurrent åŸç†æ¨èé˜…è¯»ï¼š

[Reactæºç è§£æä¹‹ä¼˜å…ˆçº§Laneæ¨¡å‹ä¸Š - æ˜é‡‘](https://juejin.cn/post/7008802041602506765)

[Reactæºç è§£æä¹‹ä¼˜å…ˆçº§Laneæ¨¡å‹ä¸‹ - æ˜é‡‘](https://juejin.cn/post/7009105181015015455)

[Reactæºç è§£æä¹‹Schedulerè§£æ - æ˜é‡‘](https://juejin.cn/post/7007613737012035592)

[React concurrent æ¨¡å¼ä»‹ç» - ByteTech](https://bytetech.info/articles/7019128966426394638)

ä¸ªäººè®¤ä¸ºä»¥ä¸Šèµ„æ–™èƒ½æ¯”æˆ‘è®²çš„å¥½ã€‚

# ä¸ªäººä½“ä¼š

è¿™é‡Œåˆ†äº«å‡ ç‚¹ä¸ªäººæ€è€ƒğŸ¤”

1.  **React çš„ workloopä½¿ç”¨äº† MessageChannel çš„API**ï¼š MessageChannel æ˜¯ä»¥ DOM Event çš„å½¢å¼å‘é€æ¶ˆæ¯ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªå®ä»»åŠ¡ï¼Œä¼šåœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯çš„å¼€å¤´æ‰§è¡Œã€‚æ‰€ä»¥èƒ½å¤Ÿä¸€ç›´ä½¿æµè§ˆå™¨çš„äº‹ä»¶å¾ªç¯è¿è¡ŒReact çš„ workloopã€‚ è¿™é‡Œæœ‰ä¸€ä¸ªä½¿ç”¨MessageChannelå®ç° event loopæç®€çš„ä»£ç  [MessageChannel - æ˜é‡‘](https://juejin.cn/post/6844903839162695688?from=search-suggest#heading-2) MDN å‚è€ƒï¼š[MessageChannel - Web API | MDN](https://developer.mozilla.org/zh-CN/docs/Web/API/MessageChannel)

2.  å¯¹äºé‚£äº›æ²¡æœ‰ä½¿ç”¨ Transtion API ï¼Œå› éƒ¨åˆ†ç”¨æˆ·æ“ä½œè€Œå¯¼è‡´çš„æ›´æ–°ï¼Œå…¶å®è¿˜æ˜¯ç›¸å½“äºåŒæ­¥æ›´æ–°ã€‚å› ä¸ºå¯¹äºç”¨æˆ·ç¦»æ•£æ“ä½œäº‹ä»¶ï¼ˆå¦‚ç‚¹å‡»ã€æ–‡æœ¬æ¡†è¾“å…¥ï¼‰ï¼Œå…¶å¯¹åº”çš„ä¼˜å…ˆçº§æ˜¯`ImmediateSchedulerPriority`ï¼Œä¼šç«‹å³æ‰§è¡Œï¼Œåœ¨è°ƒåº¦ä¸­ä¼šè¿›å…¥åŒæ­¥æ¸²æŸ“æ¨¡å¼ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨React 18å¼€å‘æ—¶ï¼Œè¦è¿›è¡Œè¿™æ–¹é¢çš„æ³¨æ„ğŸ§ã€‚ ä¸€äº›åº“ï¼Œå¦‚è·¯ç”±åº“å…¶å®ä¸ºæˆ‘ä»¬ä½œäº†å…œåº•ï¼Œæˆ‘ä»¬ç‚¹å‡»<Link />æ—¶ï¼Œä¸ºæˆ‘ä»¬æ‰§è¡Œäº†éé˜»å¡çš„æ›´æ–°ï¼Œå°±ä¸ä¼šé™·å…¥æš‚æ—¶çš„å¡æ­»ã€‚ [tanstack/react-router example](https://github.com/TanStack/router/blob/93c22c68bd1cf1af81b2c711a0dc95735022f3bd/packages/react-router/src/Transitioner.tsx#L36) å¯¹äºä¸€äº›è¿ç»­æ“ä½œï¼Œå¦‚æ»šåŠ¨ã€æ‹–æ‹½ï¼Œå…¶å¯¹åº”çš„è¿‡æœŸæ—¶é—´æ˜¯2.5ç§’ã€‚ç„¶åä¸€äº›æ•°æ®è¯·æ±‚å¸¦æ¥çš„å˜æ›´ï¼Œå…¶
    1.  ![](https://h-r2.kairi.cc/react18-concurrent-12.awebp)

3.  React 18å¸¦æ¥äº†å¾ˆå¤šå˜åŒ–ï¼Œå¯ä»¥åœ¨è¿™ä¸ªDiscussionçœ‹è§ä¸€äº›ç›¸å…³çš„è®¨è®ºã€‚ [reactwg/react-18 Â· Discussions](https://github.com/reactwg/react-18/discussions) å¦‚ï¼š
    1.  å½“ useEffect æ˜¯ç¦»æ•£æ“ä½œï¼ˆç‚¹å‡»ã€è¾“å…¥ï¼‰çš„ç»“æœæ—¶ï¼Œå®ƒä¼šåŒæ­¥è§¦å‘ã€‚[discussions/128](https://github.com/reactwg/react-18/discussions/128)

    2.  React 18 ä¸­è‡ªåŠ¨æ‰¹å¤„ç† [discussions/21](https://github.com/reactwg/react-18/discussions/21)

å‚è€ƒèµ„æ–™ï¼š

1.  React v18.0 2022-3-19 <https://react.dev/blog/2022/03/29/react-v18#what-is-concurrent-react>
2.  è¢«æ’•ç¢çš„React - Tearing 2024-10-9 <https://juejin.cn/post/7423359941854412851#heading-1>
3.  Screen Tearing Wiki <https://en.wikipedia.org/wiki/Screen_tearing>
4.  React æ’•è£‚é—®é¢˜ 2024-10-27 <https://juejin.cn/post/7430473240198545427>
5.  What is tearing? 2021-7-8 <https://github.com/reactwg/react-18/discussions/69>
6.  Concurrent React for Library Maintainers 2021-7-8 <https://github.com/reactwg/react-18/discussions/70>
7.  React.18 çš„æ–° APIã€ŒuseSyncExternalStoreã€ 2023-1-16 <https://bytetech.info/articles/7189071164596027451>
8.  ä»ç”¨æ³•åˆ°å®ç°ï¼Œä¸€æ–‡å¸¦ä½ æ‹¥æŠ±React 18 2022-5-9 <https://bytetech.info/articles/7095547016524070926>
9.  React concurrent æ¨¡å¼ä»‹ç» 2021-10-15 <https://bytetech.info/articles/7019128966426394638>
10. useSyncExternalStore - React <https://react.dev/reference/react/useSyncExternalStore#caveats>
11. Reactæºç è§£æä¹‹ä¼˜å…ˆçº§Laneæ¨¡å‹ä¸Š 2021-9-17 <https://juejin.cn/post/7008802041602506765>
