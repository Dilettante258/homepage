---
import SpanTimelineRow from "./SpanTimelineRow.astro";
import DefaultHeaderRenderer from "./DefaultHeaderRenderer.astro";
import type { Locale } from "../../i18n/strings";
import { normalizeSampleTrace } from "./sample-trace";
import type { GlobalVar, HeaderRender, RowRender } from "./types";

type Props = {
  locale: Locale;
  globalVar?: GlobalVar;
  headerRender?: HeaderRender;
  rowRender?: RowRender;
};

const { locale, globalVar = {}, headerRender, rowRender } = Astro.props;

const { nodes, startUs, totalUs } = normalizeSampleTrace();
const colW = 360;
const HeaderRenderer = headerRender ?? DefaultHeaderRenderer;

const formatDuration = (microseconds: number): string => {
  if (microseconds >= 1_000_000) {
    return `${(microseconds / 1_000_000).toFixed(2)}s`;
  }
  return `${(microseconds / 1_000).toFixed(2)}ms`;
};
---

<section
  class="spanTimeline"
  style={`--span-col-min-width:640px;--start-col-width:280px;--colW:${colW}px;--timeline-start-us:${startUs};--timeline-total-us:${totalUs};`}
>
  <div class="timelineViewport">
    <header class="headRow">
      <HeaderRenderer
        locale={locale}
        totalUs={totalUs}
        formatDuration={formatDuration}
        globalVar={globalVar}
      />
    </header>

    <div class="body spanTree">
      {
        nodes.map((node) => (
          <SpanTimelineRow
            node={node}
            timelineStartUs={startUs}
            timelineTotalUs={totalUs}
            locale={locale}
            rowRender={rowRender}
            globalVar={globalVar}
          />
        ))
      }
    </div>
  </div>
</section>

<style>
  .spanTimeline {
    min-width: 0;
    background: #fff;
    border-radius: 12px;
    --border-color: #eaedf1;
    --border: 1px solid var(--border-color);
    --hover-color: #f6f8fa;
    --span-col-min-width: 640px;
    --start-col-width: 280px;
    --colW: 360px;
    --timeline-start-us: 0;
    --timeline-total-us: 1;
    font-family: Helvetica, Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
  }

  .timelineViewport {
    width: min(100%, 1180px);
    max-height: 620px;
    overflow: auto;
    border: var(--border);
    border-radius: 12px;
    background: #fff;
  }

  .headRow {
    display: flex;
    background: #f2f4f7;
    border-bottom: var(--border);
    color: #303640;
    font-size: 14px;
    line-height: 1;
    position: sticky;
    top: 0;
    z-index: 8;
    width: 100%;
  }

  :global(.spanTimeline .headRow > div) {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 16px;
    font-weight: 600;
    border-right: var(--border);
    box-sizing: border-box;
  }

  :global(.spanTimeline .headRow > div:first-child) {
    flex: 1 1 auto;
  }

  :global(.spanTimeline .headRow > div:nth-child(2)) {
    justify-content: space-between;
    font-variant-numeric: tabular-nums;
    flex: 0 0 var(--colW);
    width: var(--colW);
  }

  :global(.spanTimeline .headRow > div:nth-child(3)) {
    flex: 0 0 var(--start-col-width);
    width: var(--start-col-width);
  }

  :global(.spanTimeline .headRow > div:last-child) {
    border-right: 0;
  }

  .body {
    background: #fff;
  }
</style>
