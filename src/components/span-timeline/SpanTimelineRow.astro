---
import DefaultRowRenderer from "./DefaultRowRenderer.astro";
import type { TimelineSpanNode } from "./sample-trace";
import type { GlobalVar, RowRender } from "./types";

type Props = {
  node: TimelineSpanNode;
  timelineStartUs: number;
  timelineTotalUs: number;
  locale: "zh" | "en";
  rowRender?: RowRender;
  globalVar?: GlobalVar;
};

const {
  node,
  timelineStartUs,
  timelineTotalUs,
  locale,
  rowRender,
  globalVar = {},
} = Astro.props;
const RowRenderer = rowRender ?? DefaultRowRenderer;
const hasChildren = node.children.length > 0;
const isOpen = hasChildren ? node.open !== false : undefined;
const isNearEnd = node.start - timelineStartUs > timelineTotalUs * 0.8;

const rowVars = `--rowStart:${node.start};--rowTotalTime:${node.duration};`;

const formatDuration = (microseconds: number): string => {
  if (microseconds >= 1_000_000) {
    return `${(microseconds / 1_000_000).toFixed(2)}s`;
  }
  return `${(microseconds / 1_000).toFixed(2)}ms`;
};

const startTimeFormatter = new Intl.DateTimeFormat(
  locale === "zh" ? "zh-CN" : "en-US",
  {
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false,
  },
);

const formatStartTime = (microseconds: number): string => {
  const parts = startTimeFormatter.formatToParts(
    new Date(Math.floor(microseconds / 1_000)),
  );
  const map = Object.fromEntries(parts.map((part) => [part.type, part.value]));
  return `${map.year}-${map.month}-${map.day} ${map.hour}:${map.minute}:${map.second}`;
};
---

<details class:list={["spanNode", { "is-leaf": !hasChildren }]} open={isOpen}>
  <summary class="spanSummary" data-error={node.error ? "true" : "false"}>
    <RowRenderer
      node={node}
      locale={locale}
      rowVars={rowVars}
      isNearEnd={isNearEnd}
      formatDuration={formatDuration}
      formatStartTime={formatStartTime}
      globalVar={globalVar}
    />
  </summary>

  {
    hasChildren && (
      <div class="children">
        {node.children.map((child) => (
          <Astro.self
            node={child}
            timelineStartUs={timelineStartUs}
            timelineTotalUs={timelineTotalUs}
            locale={locale}
            rowRender={rowRender}
            globalVar={globalVar}
          />
        ))}
      </div>
    )
  }
</details>

<style>
  :global(.spanTree details) {
    background: linear-gradient(var(--border-color), var(--border-color)) 12px
      0 / 1px 100% no-repeat;
    padding-left: 24px;
    margin: 0;
  }

  :global(.spanTree > details) {
    background: none;
    padding-left: 0;
  }

  .spanSummary {
    list-style: none;
    user-select: none;
    align-items: center;
    border-radius: 4px;
    box-sizing: border-box;
    color: #0c0d0e;
    display: flex;

    align-items: stretch;
    justify-content: flex-start;
    min-height: 32px;
  }

  .spanSummary:hover {
    background-color: var(--hover-color);
  }

  .spanSummary::-webkit-details-marker {
    display: none;
  }

  .spanSummary::marker {
    content: "";
  }

  .spanSummary::before {
    background: 50% / 50% no-repeat
      url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMiIgaGVpZ2h0PSIxMiIgZmlsbD0ibm9uZSI+PHBhdGggZmlsbD0iIzQyNDY0RSIgZD0iTTQuNzkgMi41MzRhLjUwNy41MDcgMCAwIDAtLjgxNS40MDdWOS4wNmMwIC40MjMuNDgxLjY2NC44MTUuNDA3bDMuOTg1LTMuMDU5YS41MTQuNTE0IDAgMCAwIDAtLjgxNHoiLz48L3N2Zz4=");
    content: "";
    flex-shrink: 0;
    height: 24px;
    transition:
      transform 0.2s ease-out,
      opacity 0.2s ease-out;
    width: 24px;
    align-self: center;
  }

  .spanSummary :global(.spanRow) {
    --lineColor: #97a0ad;
    flex: 1;
    min-height: 42px;
    height: 42px;
    display: flex;
    align-items: center;
  }

  .spanSummary :global(.spanCol) {
    display: flex;
    align-items: center;
    flex: 1 1 auto;
    padding: 0 8px 0 0;
  }

  .spanNode[open] > .spanSummary::before {
    transform: rotate(90deg);
  }

  .spanNode.is-leaf > .spanSummary::before {
    display: none;
  }

  .spanSummary :global(.rowConnector) {
    display: flex;
    align-items: center;
    min-width: 0;
    flex: 1;
    font-size: 1.15rem;
    color: #16181d;
  }

  .spanSummary :global(.nameText) {
    overflow: hidden;
    text-overflow: ellipsis;
    text-wrap: nowrap;
    font-size: inherit;
    line-height: 1;
    white-space: nowrap;
  }

  .spanSummary :global(.nameText.link) {
    color: #3568f0;
    font-weight: 600;
  }

  .spanSummary :global(.nameText.pill) {
    background: #f4dfb2;
    border: 1px solid #cf963a;
    border-radius: 8px;
    padding: 4px 8px;
    box-shadow: inset 0 0 0 1px #0000000d;
  }

  .spanSummary :global(.rowConnector)::after {
    background: 50% / auto 0.8px repeat-x
      repeating-linear-gradient(
        90deg,
        var(--lineColor) 0 1px,
        #0000 0 3px,
        var(--lineColor) 0 5px,
        #0000 0 7px,
        var(--lineColor) 0 8px
      );
    content: "";
    flex-grow: 1;
    flex-shrink: 1;
    height: 32px;
    margin-left: 4px;
  }

  .spanSummary :global(.rowConnector)::before {
    --length: 13.33333px;
    --color-5: #309256;
    --color-6: #2a814b;
    background:
      calc(50% + 0.16667px) calc(50% + 0.16667px) / 8px 7px no-repeat
        url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4IiBoZWlnaHQ9IjciIGZpbGw9Im5vbmUiPjxwYXRoIGZpbGw9IiMxNDE0MTQiIGZpbGwtb3BhY2l0eT0iLjIiIGZpbGwtcnVsZT0iZXZlbm9kZCIgZD0ibTcuMDMyIDEuMzYyLjQ1Ny40NTdhLjMyMy4zMjMgMCAwIDEgMCAuNDU4bC0zLjY2IDMuNjZhLjMyLjMyIDAgMCAxLS4xNy4wODlsLS4wMzkuMDA0aC0uMDM4YS4zMi4zMiAwIDAgMS0uMjEtLjA5NEwxLjMxNCAzLjg3OGEuMzIzLjMyMyAwIDAgMSAwLS40NThsLjQ1Ny0uNDU3YS4zMjMuMzIzIDAgMCAxIC40NTggMEwzLjYgNC4zMzVsMi45NzQtMi45NzNhLjMyMy4zMjMgMCAwIDEgLjQ1NyAwIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiLz48cGF0aCBmaWxsPSIjZmZmIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGQ9Im02LjcgMS4wMjkuNDU3LjQ1N2EuMzIzLjMyMyAwIDAgMSAwIC40NThsLTMuNjYgMy42NmEuMzIuMzIgMCAwIDEtLjE3Mi4wOWwtLjAzOC4wMDRIMy4yNWEuMzIuMzIgMCAwIDEtLjIxLS4wOTVMLjk4MiAzLjU0NWEuMzIzLjMyMyAwIDAgMSAwLS40NThsLjQ1Ny0uNDU3YS4zMjMuMzIzIDAgMCAxIC40NTggMGwxLjM3MiAxLjM3Mkw2LjI0MiAxLjAzYS4zMjMuMzIzIDAgMCAxIC40NTcgMCIgY2xpcC1ydWxlPSJldmVub2RkIi8+PC9zdmc+"),
      50% / 100% 100% no-repeat
        repeating-radial-gradient(
          var(--color-5),
          var(--color-5) calc(100% - 4px),
          var(--color-6) calc(100% - 4px),
          var(--color-6) 100%
        );
    border-radius: 100%;
    box-shadow: 0 0.65px 0 0 #14141414;
    content: "";
    height: var(--length);
    margin: auto calc(12px - var(--length) / 2);
    width: var(--length);
    flex-shrink: 0;
  }

  .spanSummary[data-error="true"] :global(.rowConnector)::before {
    --color-5: #ee3f38;
    --color-6: #d7312a;
    background:
      calc(50% + 0.16667px) calc(50% + 0.16667px) / 6px 6px no-repeat
        url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2IiBoZWlnaHQ9IjYiIGZpbGw9Im5vbmUiPjxwYXRoIGZpbGw9IiMxNDE0MTQiIGZpbGwtb3BhY2l0eT0iLjIiIGZpbGwtcnVsZT0iZXZlbm9kZCIgZD0ibTUuMzQ2Ljg0Ny40NjkuNDdhLjM4LjM4IDAgMCAxIDAgLjUzNUw0LjMwNiAzLjM2MWwxLjUwOSAxLjUwOGEuMzguMzggMCAwIDEgMCAuNTM2bC0uNDcuNDdhLjM4LjM4IDAgMCAxLS41MzYgMEwzLjMgNC4zNjVsLTEuNTA3IDEuNTFhLjM4LjM4IDAgMCAxLS41MzYgMGwtLjQ3LS40N2EuMzguMzggMCAwIDEgMC0uNTM2TDIuMjk2IDMuMzYuNzg4IDEuODUzYS4zOC4zOCAwIDAgMSAwLS41MzZsLjQ2OS0uNDdhLjM4LjM4IDAgMCAxIC41MzYgMEwzLjMgMi4zNTUgNC44MS44NDdhLjM4LjM4IDAgMCAxIC41MzYgMCIgY2xpcC1ydWxlPSJldmVub2RkIi8+PHBhdGggZmlsbD0iI2ZmZiIgZmlsbC1ydWxlPSJldmVub2RkIiBkPSJtNS4wMTQuNTE1LjQ2OS40N2EuMzguMzggMCAwIDEgMCAuNTM2TDMuOTc0IDMuMDI5bDEuNTA5IDEuNTA4YS4zOC4zOCAwIDAgMSAwIC41MzdsLS40Ny40NjlhLjM4LjM4IDAgMCAxLS41MzUgMGwtMS41MS0xLjUxLTEuNTA3IDEuNTFhLjM4LjM4IDAgMCAxLS41MzYgMGwtLjQ3LS40N2EuMzguMzggMCAwIDEgMC0uNTM2bDEuNTA4LTEuNTA4TC40NTYgMS41MmEuMzguMzggMCAwIDEgMC0uNTM2bC40NjktLjQ3YS4zOC4zOCAwIDAgMSAuNTM2IDBMMi45NyAyLjAyNCA0LjQ3OC41MTVhLjM4LjM4IDAgMCAxIC41MzYgMCIgY2xpcC1ydWxlPSJldmVub2RkIi8+PC9zdmc+"),
      50% / 100% 100% no-repeat
        repeating-radial-gradient(
          var(--color-5),
          var(--color-5) calc(100% - 4px),
          var(--color-6) calc(100% - 4px),
          var(--color-6) 100%
        );
  }

  .spanSummary :global(.timeCol) {
    --rowStart: 0;
    --rowTotalTime: 0;
    --left: calc(
      (var(--rowStart) - var(--timeline-start-us)) / var(--timeline-total-us) *
        var(--colW)
    );
    --right: calc(
      var(--colW) - var(--left) - var(--rowTotalTime) /
        var(--timeline-total-us) * var(--colW)
    );
    height: 100%;
    position: relative;
    background: transparent;
    font-variant-numeric: tabular-nums;
    overflow: hidden;
    flex: 0 0 var(--colW);
    width: var(--colW);
  }

  .spanSummary :global(.timelineSpan) {
    --left: calc(
      (var(--rowStart) - var(--timeline-start-us)) / var(--timeline-total-us) *
        var(--colW)
    );
    --right: calc(
      var(--colW) - var(--left) - var(--rowTotalTime) /
        var(--timeline-total-us) * var(--colW)
    );
    background: #d1f5dd;
    box-sizing: border-box;
    color: #0d5436;
    flex-shrink: 0;
    position: absolute;
    top: 1px;
    bottom: 1px;
    left: var(--left);
    padding: 0;
    width: max(calc(var(--colW) - var(--left) - var(--right)), 0.5px);
    display: block;
  }

  .spanSummary :global(.durationText) {
    position: absolute;
    top: 50%;
    left: clamp(6px, calc(var(--left) + 6px), calc(100% - 84px));
    transform: translateY(-50%);
    color: #245e42;
    font-size: 1.15rem;
    line-height: 1;
    white-space: nowrap;
  }

  .spanSummary :global(.durationText.from-right) {
    left: auto;
    right: clamp(6px, calc(var(--right) + 6px), calc(100% - 84px));
    text-align: right;
  }

  .spanSummary[data-error="true"] :global(.timelineSpan) {
    background: #f7d7d3;
    color: #bb3a2f;
  }

  .spanSummary[data-error="true"] :global(.durationText) {
    color: #bf3b32;
  }

  .spanSummary :global(.startCol) {
    padding: 0 10px 0 12px;
    color: #1d232c;
    font-size: 1.15rem;
    line-height: 1;
    white-space: nowrap;
    background: transparent;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 0 0 var(--start-col-width);
    width: var(--start-col-width);
  }

  .children {
    margin: 0;
  }
</style>
