---
import { SUPPORTED_LOCALES, type Locale } from "../i18n/strings";

type Props = { locale: Locale };
const { locale } = Astro.props;

const buildHref = (target: Locale) => {
  const segments = Astro.url.pathname.split("/").filter(Boolean);

  // 如果是首页，直接返回目标语言首页
  if (!segments.length || segments.length === 1) {
    return `/${target}`;
  }

  // 替换语言代码（第一个段）
  segments[0] = target;

  // 检查是否是详情页（3个或更多段，如 /zh/blog/post-slug）
  // 如果是详情页，只保留到列表页级别（如 /en/blog）
  // 因为详情页的 slug 可能在不同语言下不存在
  if (segments.length > 2) {
    // 保留语言和分类（如 blog, gallery, projects）
    return `/${segments[0]}/${segments[1]}`;
  }

  // 列表页或其他页面，保持完整路径
  return `/${segments.join("/")}`;
};
---

<div
  class="switcher"
  aria-label="Choose language"
>
  {
    SUPPORTED_LOCALES.map((code) => (
      <a
        data-locale={code}
        data-active={code === locale ? "true" : undefined}
        href={buildHref(code)}
      >
        <span>{code.toUpperCase()}</span>
      </a>
    ))
  }
</div>

<script>
  function updateActiveLocale() {
    const switcher = document.querySelector(".switcher");
    if (!switcher) return;

    const currentPath = window.location.pathname;
    const segments = currentPath.split("/").filter(Boolean);
    const currentLocale = segments[0] || "zh";

    const links = switcher.querySelectorAll("a");
    links.forEach((link) => {
      const locale = link.getAttribute("data-locale");
      if (locale === currentLocale) {
        link.setAttribute("data-active", "true");
      } else {
        link.removeAttribute("data-active");
      }
    });
  }

  // 使用 astro:page-load 统一处理初始化和导航后更新
  document.addEventListener("astro:page-load", updateActiveLocale);
</script>

<style>
  .switcher {
    position: relative;
    display: inline-flex;
    gap: 2px;
    border: 1px solid var(--stroke);
    border-radius: 10px;
    padding: 3px;
    background: var(--surface);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }

  .switcher a {
    position: relative;
    color: var(--muted);
    text-decoration: none;
    font-weight: 500;
    font-size: 0.8rem;
    padding: 0;
    border-radius: 7px;
    transition: color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1;
  }

  .switcher a span {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
  }

  .switcher a:hover {
    color: var(--text);
  }

  .switcher a:hover:not([data-active="true"]) span {
    transform: scale(1.05);
  }

  .switcher a[data-active="true"] {
    color: var(--text);
  }

  .switcher a[data-active="true"] span {
    anchor-name: --active-lang;
  }

  /* Sliding background indicator */
  .switcher::before {
    content: "";
    position: absolute;
    z-index: 0;
    background: var(--surface-tag);
    border-radius: 7px;
    position-anchor: --active-lang;
    top: anchor(top);
    bottom: anchor(bottom);
    left: anchor(left);
    right: anchor(right);
    transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  /* Fallback for browsers without anchor positioning support */
  @supports not (anchor-name: --test) {
    .switcher::before {
      display: none;
    }

    .switcher a[data-active="true"] {
      background: var(--surface-tag);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
  }
</style>
